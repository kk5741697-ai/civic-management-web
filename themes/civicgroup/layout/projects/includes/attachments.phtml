<?php 
// First, filter out any attachments without a name or without an existing file
$valid_attachments = array_filter(
    $project_data['attachments'],
    function($att) use ($wo) {
        return
            !empty($att['name']) &&
            !empty($att['file_path']) &&
            file_exists($att['file_path']);
    }
);

// Only render the attachments list if we have at least one valid item
if (count($valid_attachments) > 0): ?>
<div class="rh_property__attachments_wrap margin-bottom-40px">
    <h4 class="rh_property__heading">
        <?= $project->type === 'land' ? 'Project' : 'Property'; ?> Attachments
    </h4>
    <ul class="rh_property__attachments">
        <?php foreach ($valid_attachments as $value):
            $ext = strtolower(pathinfo($value['file_path'], PATHINFO_EXTENSION));
            $url = rtrim($wo['config']['site_url'], '/') . '/' . ltrim($value['file_path'], '/');

            // Calculate human-readable file size
            $size = filesize($value['file_path']);
            if ($size >= 1073741824) {
                $file_size = round($size / 1073741824, 2) . ' GB';
            } elseif ($size >= 1048576) {
                $file_size = round($size / 1048576, 2) . ' MB';
            } else {
                $file_size = round($size / 1024, 2) . ' KB';
            }
        ?>
        <li class="<?= htmlspecialchars($ext, ENT_QUOTES, 'UTF-8'); ?>">
            <a target="_blank" href="<?= htmlspecialchars($url, ENT_QUOTES, 'UTF-8'); ?>" class="rh-attachment-link">
                <?php
                // Choose icon by extension
                switch ($ext) {
                    case 'pdf':    echo '<i class="far fa-file-pdf"></i>'; break;
                    case 'doc':
                    case 'docx':   echo '<i class="far fa-file-word"></i>'; break;
                    case 'ppt':
                    case 'pptx':   echo '<i class="far fa-file-powerpoint"></i>'; break;
                    case 'txt':    echo '<i class="far fa-file-alt"></i>'; break;
                    case 'zip':
                    case 'rar':    echo '<i class="far fa-file-archive"></i>'; break;
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':    echo '<i class="far fa-file-image"></i>'; break;
                    case 'xls':
                    case 'xlsx':   echo '<i class="far fa-file-excel"></i>'; break;
                    case 'csv':    echo '<i class="far fa-file-csv"></i>'; break;
                    case 'mp4':
                    case 'avi':
                    case 'mov':    echo '<i class="far fa-file-video"></i>'; break;
                    case 'mp3':
                    case 'wav':    echo '<i class="far fa-file-audio"></i>'; break;
                    case 'xml':
                    case 'json':   echo '<i class="far fa-file-code"></i>'; break;
                    default:       echo '<i class="far fa-file"></i>'; break;
                }
                ?>

                <span class="rh-attachment-text">
                    <?= htmlspecialchars($value['name'], ENT_QUOTES, 'UTF-8'); ?><br>
                    <span><?= htmlspecialchars($file_size, ENT_QUOTES, 'UTF-8'); ?></span>
                </span>
                <span class="rh-attachment-download-icon">
                    <!-- download icon SVG unchanged -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-download">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                </span>
            </a>
        </li>
        <?php endforeach; ?>
    </ul>
</div>
<?php endif; ?>