<?php
if (!empty($project_data['video']) && is_array($project_data['video'])):
    $video_items = $project_data['video'];
    $site_url = $wo['config']['site_url'];
?>
<div class="rh_property__video margin-bottom-40px">
    <h4 class="rh_property__heading">Property Video</h4>

    <?php
    // Prepare first video
    $first = $video_items[0];
    $first_url = is_array($first) ? ($first['url'] ?? '') : $first;
    $first_thumb = is_array($first) && !empty($first['thumb']) ? $site_url . '/' . $first['thumb'] : '';
    $first_title = is_array($first) ? ($first['title'] ?? '') : '';
    ?>

    <div class="rh_property_video">
        <div class="rh_property_video_inner">
            <?php if ($first_title): ?>
            <h5 class="rh_video_title"><?= htmlspecialchars($first_title, ENT_QUOTES) ?></h5>
            <?php endif; ?>
            <a id="video-fancybox-trigger" href="javascript:void(0);" class="inspiry-lightbox-item">
                <div class="play-btn"><i class="fas fa-play"></i></div>
                <img src="<?= htmlspecialchars($first_thumb ?: $site_url . '/themes/civicgroup/img/comming-soon.jpg', ENT_QUOTES) ?>"
                    alt="<?= htmlspecialchars($first_title, ENT_QUOTES) ?>"
                    class="attachment-property-detail-video-image">
            </a>
        </div>
    </div>
</div>

<script>
jQuery(function($) {
    const videoItems = <?php
        // Prepare JS array with embed links and autoplay=1
        $fancyboxVideos = [];
        foreach ($video_items as $video) {
            $url = is_array($video) ? ($video['url'] ?? '') : $video;

            // Convert to embed + autoplay
            if (preg_match('/youtu\.be\/([^\?\&]+)/', $url, $m)) {
                $url = 'https://www.youtube.com/embed/' . $m[1] . '?autoplay=1';
            } elseif (preg_match('/youtube\.com\/watch\?v=([^\&]+)/', $url, $m)) {
                $url = 'https://www.youtube.com/embed/' . $m[1] . '?autoplay=1';
            }

            if ($url !== '') {
                $fancyboxVideos[] = ['src' => $url, 'type' => 'iframe'];
            }
        }
        echo json_encode($fancyboxVideos);
    ?>;

    $('#video-fancybox-trigger').on('click', function() {
        $.fancybox.open(videoItems, {
            loop: false,
            buttons: ["close"],
            animationEffect: "zoom",
            animationDuration: 300,
            iframe: {
                preload: false
            }
        });
    });
});
</script>
<?php endif; ?>