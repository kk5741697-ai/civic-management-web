<?php
// 1) Core values with inline guards + decode any HTML entities
$site_url    = isset($wo['config']['site_url']) ? html_entity_decode($wo['config']['site_url'], ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';
$proj_id     = isset($project->id) ? $project->id : 0;
$proj_name   = isset($project->name) ? html_entity_decode($project->name, ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';
$proj_type   = isset($project->type) ? html_entity_decode($project->type, ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';
$proj_prog   = isset($project->progress) ? html_entity_decode($project->progress, ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';
$proj_loc    = isset($project->location) ? html_entity_decode($project->location, ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';
$proj_coords = isset($project->location_coords) ? html_entity_decode($project->location_coords, ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';
$proj_price  = isset($project_data['price']) ? html_entity_decode($project_data['price'], ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';
$proj_katha  = isset($project_data['katha']) ? html_entity_decode($project_data['katha'], ENT_QUOTES|ENT_HTML5, 'UTF-8') : '';

// 2) URL & thumbnail
$url = $site_url . '/projects/' . $proj_id . '_' . urlencode($proj_name);
if (!empty($project->avatar)) {
    $thumbnail = html_entity_decode($wo['config']['site_url'], ENT_QUOTES|ENT_HTML5, 'UTF-8')
               . '/' . html_entity_decode($project->avatar, ENT_QUOTES|ENT_HTML5, 'UTF-8');
} else {
    $thumbnail = $site_url . '/themes/civicgroup/img/comming-soon.jpg';
}

// --- 3) Project tag ---
if ($proj_type === 'land') {
    $project_tag = 'Land Project';
} elseif ($proj_type === 'apartment') {
    $project_tag = 'Apartment Project';
} elseif ($proj_type === 'car') {
    $project_tag = 'Car Dealership';
} else {
    $project_tag = '';
}

// --- 4) Gallery & video arrays + counts ---
$gallery_items = (isset($project_data['gallery']) && is_array($project_data['gallery'])) ? $project_data['gallery'] : [];
$video_items   = (isset($project_data['video']) && is_array($project_data['video'])) ? $project_data['video'] : [];
$gallery_count = count($gallery_items);
$video_count   = count($video_items);

// 5) Prepare JS-friendly arrays (always strings for `src`)
$jsGalleryItems = array_map(function($u){
    return ['src'=> (string)$u, 'type'=>'image'];
}, $gallery_items);

$jsVideoItems = [];
foreach ($video_items as $v) {
    $video_url = '';

    if (is_array($v) && !empty($v['url'])) {
        $video_url = $v['url'];
    } elseif (is_string($v) && $v !== '') {
        $video_url = $v;
    }

    // Fix: Convert watch?v= or youtu.be to embed format
    if (preg_match('/youtu\.be\/([^\?\&]+)/', $video_url, $m)) {
        $video_url = 'https://www.youtube.com/embed/' . $m[1] . '?autoplay=1';
    } elseif (preg_match('/youtube\.com\/watch\?v=([^\&]+)/', $video_url, $m)) {
        $video_url = 'https://www.youtube.com/embed/' . $m[1] . '?autoplay=1';
    }    

    if ($video_url !== '') {
        $jsVideoItems[] = ['src' => $video_url, 'type' => 'iframe'];
    }
}


?>

<div class="col-12 col-sm-6 col-lg-4 project-item <?php echo htmlspecialchars($proj_type, ENT_QUOTES); ?>">
    <div>

        <div class="civic-card civic-card-thumb">
            <a href="<?php echo $url; ?>">
                <img src="<?php echo $thumbnail; ?>" alt="<?php echo htmlspecialchars($proj_name, ENT_QUOTES); ?>">
            </a>
            <div class="civic-card-fav">
                <button class="fav-btn" title="Add to favourites">❤️</button>
            </div>

            <div class="civic-card-tags">

                <div class="rh-ultra-status-box">
                    <a href="#" class="status">
                        <?php echo htmlspecialchars(ucwords($proj_prog), ENT_QUOTES); ?>
                    </a>
                </div>

                <!-- Media counts -->
                <div class="rh-ultra-media-count rh-media-light">

                    <?php if ($gallery_count > 0): // show only if images exist ?>
                    <div class="rh-media rh-media-image" id="gallery-trigger-<?php echo $proj_id; ?>">
                        <!-- image SVG icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18">
                            <style>
                            .rh-photo-st0 {
                                fill-rule: evenodd;
                                clip-rule: evenodd;
                            }
                            </style>
                            <path class="rh-ultra-black rh-photo-st0"
                                d="M3 5h12c1.1 0 2 .9 2 2v8c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2zM7.7 1h2.8c.8-.2 1.7.4 1.8 1.2L13 5H5l.7-2.7C5.8 1.4 6.7.8 7.7 1zM9 7.4c2.2 0 4 1.8 4 4s-1.8 4-4 4-4-1.8-4-4 1.8-4 4-4z" />
                        </svg>
                        <span><?php echo $gallery_count; ?></span>
                    </div>
                    <?php endif; ?>

                    <?php if ($video_count > 0): // show only if videos exist ?>
                    <div class="rh-media rh-media-video" id="video-trigger-<?php echo $proj_id; ?>">
                        <!-- video SVG icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18">
                            <style>
                            .st0 {
                                fill-rule: evenodd;
                                clip-rule: evenodd;
                            }
                            </style>
                            <path class="st0"
                                d="M4 1h10c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H4C2.3 17 1 15.7 1 14V4C1 2.3 2.3 1 4 1zm7.2 8.2l-4 2.3V6.1l4 2.3z" />
                        </svg>
                        <span><?php echo $video_count; ?></span>
                    </div>
                    <?php endif; ?>

                </div><!-- /.rh-ultra-media-count -->

                <!-- Hidden Fancybox items -->
                <div style="display:none;">
                    <?php foreach ($gallery_items as $img_url): ?>
                    <a data-fancybox="gallery-<?php echo $proj_id; ?>" href="<?php echo $img_url; ?>"></a>
                    <?php endforeach; ?>

                    <?php foreach ($video_items as $vid_url): ?>
                    <a data-fancybox="video-<?php echo $proj_id; ?>" href="<?php echo $vid_url; ?>"></a>
                    <?php endforeach; ?>
                </div>

            </div><!-- /.civic-card-tags -->
        </div><!-- /.civic-card-thumb -->


        <div class="civic-card-body">
            <h3 class="civic-title">
                <a href="<?php echo $url; ?>">
                    <?php echo htmlspecialchars($proj_name, ENT_QUOTES); ?>
                </a>
            </h3>

            <?php if ($proj_loc !== ''): ?>
            <a class="civic-address" data-rhea-map-source="rhea-map-source-<?php echo $proj_id; ?>"
                data-rhea-map-location="<?php echo htmlspecialchars($proj_coords, ENT_QUOTES); ?>"
                data-rhea-map-title="<?php echo htmlspecialchars($proj_name, ENT_QUOTES); ?>"
                data-rhea-map-price="<?php echo htmlspecialchars($proj_price, ENT_QUOTES); ?>"
                data-rhea-map-thumb="<?php echo $thumbnail; ?>" href="<?php echo $url; ?>">
                <i class="pin-icon fa-solid fa-location-dot"></i>
                <?php echo htmlspecialchars($proj_loc, ENT_QUOTES); ?>
            </a>
            <?php endif; ?>

            <span class="civic-type">
                <small>
                    <a href="<?php echo $site_url; ?>/projects/<?php echo htmlspecialchars($proj_type, ENT_QUOTES); ?>">
                        <?php echo htmlspecialchars($project_tag, ENT_QUOTES); ?>
                    </a>
                </small>
            </span>

            <div class="civic-price-meta">
                <div class="civic_prop_card__priceLabel">
                    <p class="civic_prop_card__price"><?php echo htmlspecialchars($proj_price, ENT_QUOTES); ?></p>
                </div>

                <div class="civic_prop_card_meta_wrap civic-ui-tooltip">
                    <?php if ($proj_type === 'land'): ?>
                    <div class="civic_prop_card__meta" style="order:1;">
                        <h5 class="civic-meta-icons-labels">Bedrooms</h5>
                        <div class="civic_meta_icon_wrapper">
                            <span class="civic_meta_icon" title="Bedrooms">
                                <!-- bedroom SVG here -->
                            </span>
                        </div>
                    </div>
                    <div class="civic_prop_card__meta">
                        <span class="figure"><?php echo htmlspecialchars($proj_katha, ENT_QUOTES); ?></span>
                        <span class="label">KATHA</span>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div><!-- /.civic-card-body -->

    </div>
</div>

<!-- Fancybox trigger script -->
<script>
jQuery(function($) {
    <?php if ($gallery_count > 0): ?>
    // build gallery array
    var galleryItems = <?php echo json_encode(array_map(function($u){
        return ['src'=>$u,'type'=>'image'];
    }, $gallery_items)); ?>;
    $('#gallery-trigger-<?php echo $proj_id; ?>').on('click', function() {
        $.fancybox.open(galleryItems, {
            loop: false
        });
    });
    <?php endif; ?>

    <?php if ($video_count>0): ?>
    var videoItems = <?= json_encode($jsVideoItems) ?>;
    $('#video-trigger-<?= $proj_id ?>').on('click', function() {
        $.fancybox.open(videoItems, {
            loop: false
        });
    });
    <?php endif; ?>
});
</script>