<div>
<!--start breadcrumb-->
<?php
// Handle project switch
$wo['get_project'] = $project = isset($_GET["project"]) ? Wo_Secure($_GET["project"]) : ($_COOKIE["project"] ?? 'all');
// setcookie("project", $project, time() + 10 * 365 * 24 * 60 * 60, "/");

$get_project = [
    'all' => 'All',
    'moon_hill' => 'Moon Hill',
    'hill_town' => 'Hill Town',
];

if ($project == 'moon_hill') {
    $wo['get_page_id'] = $page_id = '1932174893479181';
    $wo['get_page_name'] = $page_name = 'Civic Real Estate Ltd.';
} else if ($project == 'hill_town') {
    $wo['get_page_id'] = $page_id = '259547413906965';
    $wo['get_page_name'] = $page_name = 'Civic Design & Development Ltd.';
} else {
    $wo['get_page_id'] = $page_id = '0';
    $wo['get_page_name'] = $page_name = 'N/A';
}
?>
</div>
<div class="page-breadcrumb d-flex align-items-center mb-3" style="justify-content: space-between;">
  <div class="breadcrumb-title pe-3"><?php echo $wo['title']; ?></div>
	<select id="project" name="project" class="form-select w-auto wm-100" onchange="project_switch()">
		<?php 
			foreach ($get_project as $key => $name) {
				echo '<option' . ($project == $key ? ' selected' : '') . " value='{$key}'>{$name}</option>";
			}
		?>
	</select>
    <div class="select-panel d-flex justify-content-between">
        <!-- Use flatpickr for date selection -->
        <input class="form-select w-auto" type="text" id="date_start_end" name="date_start_end" placeholder="Select date range" readonly onchange="DataTableReset()" value="<?php echo urldecode($_COOKIE['start_end2']); ?>">
    </div>
</div>
<!--end breadcrumb-->

<div class="mb-3">
	<div class="row row-cols-auto g-3">
		<div class="col">
		</div>
	</div>
</div>
<style>
tr:hover, tr:focus, tr:active {
    --bs-table-bg: #f3f3f3;
}
</style>
<?php
// ini_set('display_errors', '1');
// ini_set('display_startup_errors', '1');
// error_reporting(E_ALL);

$get_users = $db->orderBy('position', 'ASC')->where('active', '1')->where('banned', '0')->where('is_team_leader', '0')->where('leader_id', '0', '>')->get(T_USERS, null, ['user_id']);
$msg_type = 'lead';
// Get the start and end of the current month
$month_start = strtotime('first day of this month 00:00:00');
$month_end = strtotime('last day of this month 23:59:59');

echo Wo_LoadManagePage('view_notif/content');

function count_leads2($status) {
    global $db, $wo;

    $page_id = $wo['get_page_id'];

    // 1️⃣ Date range from cookie or default to this month
    $starttoend = isset($_COOKIE['start_end2']) ? urldecode($_COOKIE['start_end2']) : '';
    if (!empty($starttoend)) {
        [$date_start, $date_end] = array_pad(explode(' to ', $starttoend), 2, '');
    }
    if (empty($date_start)) $date_start = date('Y-m-01');
    if (empty($date_end))   $date_end   = $date_start;
    $date_start .= ' 00:00:00';
    $date_end   .= ' 23:59:59';

    $start_timestamp = strtotime($date_start);
    $end_timestamp   = strtotime($date_end);

    // 2️⃣ Base filters
    $db->where('status',  $status);
    $db->where('created', $start_timestamp, '>=');
    $db->where('created', $end_timestamp,   '<=');

    // 3️⃣ Project filter (only if not “all”)
    if ($wo['get_project'] !== 'all') {
        $db->where(
            "JSON_UNQUOTE(JSON_EXTRACT(additional, '$.page_id')) = ?",
            [$page_id],
            null
        );

    }

    // 4️⃣ Role‐based filters
    if (Wo_IsAdmin() || Wo_IsModerator() || check_permission('manage-leads')) {
        // any assigned or any member
        $db->where('(assigned > 0 OR member > 0)');
    }
    elseif ($wo['user']['is_team_leader']) {
        $db->where('assigned', $wo['user']['user_id']);
    }
    else {
        // your leader or you as member
        $db->where(
            '(assigned = ' . intval($wo['user']['leader_id'])
          . ' OR member = ' . intval($wo['user']['user_id']) . ')'
        );
    }

    // 5️⃣ Finally, get the count
    return $db->getValue(T_LEADS, 'COUNT(*)') ?? 0;
}

?>
<div class="row row-cols-2 row-cols-lg-3 row-cols-xl-3 row-cols-xxl-6">
	<div class="col">
		<div class="card radius-10">
			<div class="card-body">
				<div class="d-flex align-items-start gap-2">
					<div>
						<p class="mb-0 fs-6">Not Started</p>
					</div>
					<div class="ms-auto">
						<ion-icon name="bar-chart" role="img" class="md hydrated" aria-label="bar-chart"></ion-icon>
					</div>
				</div>
				<div class="d-flex align-items-center mt-3">
					<div>
						<h4 class="mb-0"><?php echo count_leads2(0); ?></h4>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col">
		<div class="card radius-10">
			<div class="card-body">
				<div class="d-flex align-items-start gap-2">
					<div>
						<p class="mb-0 fs-6">Not Interested</p>
					</div>
					<div class="ms-auto">
						<ion-icon name="bar-chart" role="img" class="md hydrated" aria-label="bar-chart"></ion-icon>
					</div>
				</div>
				<div class="d-flex align-items-center mt-3">
					<div>
						<h4 class="mb-0"><?php echo count_leads2(9) + count_leads2(10) + count_leads2(11) + count_leads2(12); ?></h4>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col">
		<div class="card radius-10">
			<div class="card-body">
				<div class="d-flex align-items-start gap-2">
					<div>
						<p class="mb-0 fs-6">Positive</p>
					</div>
					<div class="ms-auto">
						<ion-icon name="bar-chart" role="img" class="md hydrated" aria-label="bar-chart"></ion-icon>
					</div>
				</div>
				<div class="d-flex align-items-center mt-3">
					<div>
						<h4 class="mb-0"><?php echo count_leads2(14); ?></h4>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col">
		<div class="card radius-10">
			<div class="card-body">
				<div class="d-flex align-items-start gap-2">
					<div>
						<p class="mb-0 fs-6">Visit Done</p>
					</div>
					<div class="ms-auto">
						<ion-icon name="bar-chart" role="img" class="md hydrated" aria-label="bar-chart"></ion-icon>
					</div>
				</div>
				<div class="d-flex align-items-center mt-3">
					<div>
						<h4 class="mb-0"><?php echo count_leads2(6); ?></h4>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col">
		<div class="card radius-10">
			<div class="card-body">
				<div class="d-flex align-items-start gap-2">
					<div>
						<p class="mb-0 fs-6">Sale Done</p>
					</div>
					<div class="ms-auto">
						<ion-icon name="bar-chart" role="img" class="md hydrated" aria-label="bar-chart"></ion-icon>
					</div>
				</div>
				<div class="d-flex align-items-center mt-3">
					<div>
						<h4 class="mb-0"><?php echo count_leads2(5); ?></h4>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col">
		<div class="card radius-10">
			<div class="card-body">
				<div class="d-flex align-items-start gap-2">
					<div>
						<p class="mb-0 fs-6">Remaining Leave</p>
					</div>
					<div class="ms-auto">
						<ion-icon name="bar-chart" role="img" class="md hydrated" aria-label="bar-chart"></ion-icon>
					</div>
				</div>
				<div class="d-flex align-items-center mt-3">
					<div>
						<h4 class="mb-0"><?php echo str_replace('-', 'Overused: -', remaining_leave($wo['user']['user_id'])); ?></h4>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="row row-cols-1 row-cols-lg-2 row-cols-xl-2 row-cols-xxl-3" id="result"></div>


<!-- Your HTML code starts here -->
<div class="card radius-10 w-100">
    <div class="card-body">
        <div class="table-responsive mt-2">
            <table id="invoiceTable" class="table align-middle mb-0" style="width: 100%;">
                <thead class="table-light">
					<tr>
						<th style="width: 45px;">Name</th>
						<th style="width: 45px;">Leader</th>
						<?php 
						function lead_count($db, $user_id, $status, $date_start = '', $date_end = '') {
                            // Get start and end date from cookie
                            $starttoend = isset($_COOKIE['start_end2']) ? urldecode($_COOKIE['start_end2']) : '';
                        
                            if (!empty($starttoend)) {
                                $exp = explode(' to ', $starttoend);
                                $date_start = $exp[0] ?? '';
                                $date_end = $exp[1] ?? '';
                            }
                            // If $date_start is empty, set it to the first day of the current month
                            if (empty($date_start)) {
                                $date_start = date('Y-m-01'); // First day of the current month
                            }
                        
                            // If $date_end is empty, set it to the last day of the current month
                            if (empty($date_end)) {
                                $date_end = $date_start; // Last day of the current month
                            }
                        
                            // Append time for correct timestamp conversion
                            $date_start .= ' 00:00:00';
                            $date_end .= ' 23:59:59';
                            
                            $start_timestamp = strtotime($date_start);
                            $end_timestamp = strtotime($date_end);

							$user_data = Wo_UserData($user_id);
							if ($user_data['is_team_leader']) {
								return $db->where('assigned', $user_id)
										  ->where('status', $status)
										  ->where('member', 0, '<=')
										  ->where('created', $start_timestamp, '>=')
										  ->where('created', $end_timestamp, '<=')
										  ->getValue(T_LEADS, 'COUNT(*)');
							} else {
								return $db->where('assigned', '0', '>')
										  ->where('status', $status)
										  ->where('member', $user_id)
										  ->where('created', $start_timestamp, '>=')
										  ->where('created', $end_timestamp, '<=')
										  ->getValue(T_LEADS, 'COUNT(*)');
							}
						}

						$get_status = array(
							'0' => 'Not Started',
							'9' => 'Not Interest',
							'14' => 'Positive',
							'6' => 'Visit Done',
							'5' => 'Sale Done',
						);

						foreach ($get_status as $key => $status) {
							echo '<th style="width: 65px;" class="text-center">' . htmlspecialchars($status) . '</th>';
						}
						?>
					</tr>
				</thead>
				<tbody>
					<?php 
					$get_users = $db->orderBy('position', 'ASC')
									->where('user_id', $wo['user']['user_id'])
									->orWhere('leader_id', $wo['user']['user_id'])
									->where('active', '1')
									->where('banned', '0')
									->where('admin', '0')
									->get(T_USERS);

					foreach ($get_users as $user) {
						?>
						<tr role="row" class="odd" data-id="<?php echo htmlspecialchars($user->user_id); ?>" <?php echo ($user->is_team_leader) ? 'style="--bs-table-bg: #f3f3f3;"' : ''; ?>>
							<td style="font-weight: 500"><img src="/<?php echo htmlspecialchars($user->avatar); ?>" class="user-img" style=" width: 24px; height: 24px; border-radius: 35px; margin-right: 8px; "><?= htmlspecialchars(ucfirst($user->first_name) . (!empty($user->last_name) ? ' ' . ucfirst($user->last_name) : '')); ?></td>
							<td>
								<?php
								if ($user->is_team_leader) {
									echo 'Team Leader';
								} else if ($user->leader_id > 0) {
									$leader_info = Wo_UserData($user->leader_id);
									echo htmlspecialchars($leader_info['name']);
								}
								?>
							</td>
							<?php
							foreach ($get_status as $key => $status) {
							    if ($status == 9) {
								    echo '<td class="text-center">' . htmlspecialchars(lead_count($db, $user->user_id, 9) + lead_count($db, $user->user_id, 10) + lead_count($db, $user->user_id, 11) + lead_count($db, $user->user_id, 12)) . '</td>';
							    } else {
								    echo '<td class="text-center">' . htmlspecialchars(lead_count($db, $user->user_id, $key)) . '</td>';
							    }
							}
							?>
						</tr>
					<?php } ?>
				</tbody>
            </table>
        </div>
    </div>
</div>

<script>
function setCookie(name, value, days = 0, path = '/', domain = '', secure = false) {
    let cookieString = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`;

    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        cookieString += `; expires=${date.toUTCString()}`;
    }

    if (path) {
        cookieString += `; path=${path}`;
    }

    if (domain) {
        cookieString += `; domain=${domain}`;
    }

    if (secure) {
        cookieString += `; secure`;
    }

    document.cookie = cookieString;
}

var date_start_end = document.getElementById('date_start_end');

date_start_end.addEventListener('change', function handleChange(event) {
    var project_value = $('#project').val();
	var targeted_value = event.target.value;
	setCookie('start_end2', targeted_value, 7);
	setCookie('project', project_value, 7);
    SMColibri.spa_load("<?php echo(Wo_LoadManageLinkSettings('home')); ?>?period=" + targeted_value + "&project=" + project_value);
});

var project_select = document.getElementById('project');
project_select.addEventListener('change', function handleChange(event) {
	var targeted_value = event.target.value;
    var date_value = $('#date_start_end').val();
	setCookie('project', targeted_value, 7);
	setCookie('start_end2', date_value, 7);
    SMColibri.spa_load("<?php echo(Wo_LoadManageLinkSettings('home')); ?>?period=" + date_value + "&project=" + targeted_value);
});
// date_start_end.focus();


function project_switch() {
// 	var project_value = $('#project').val();
//     var date_start_end = document.getElementById('date_start_end');
//     var date_value = date_start_end.value;
// 	setCookie('start_end2', date_value, 7);
// 	setCookie('project', project_value, 7);
//     SMColibri.spa_load("<?php echo(Wo_LoadManageLinkSettings('home')); ?>?period=" + date_value + "&project=" + project_value);
}




function fetch_report() {
	var dateRange = document.getElementById('date_start_end').value;
	// If date range is not selected, use the single selected date
	var dates = dateRange.split(' to ');
	var data_start = dates[0];
	var data_end = dates.length > 1 ? dates[1] : data_start;
	var project_value = $('#project').val();
				
	$.ajax({
		type: "POST",
		url: Wo_Ajax_Requests_File() + '?f=lead_report&s=fetch_report',
		data: { data_start: data_start, data_end: data_end, project: project_value },
		success: function (response) {
			if (response['status'] == 200) {
				$("#result").html(response['result']);
				$(".intotal").html($('#intotal').val());
				$(".intotalPendings").html($('#intotalPendings').val());
				$(".intotalPositive").html($('#intotalPositive').val());
				$(".intotalNegative").html($('#intotalNegative').val());
				$(".intotalParcent").html($('#intotalParcent').val());
			}
		}
	});
}

$(document).ready(function() {
    
    var project_value = $('#project').val();
    // Initialize Flatpickr
    var flatpickrInstance = flatpickr('#date_start_end', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        altFormat: 'F j, Y',
        altInput: false,
        allowInput: false,
        clickOpens: true,
        onChange: function(selectedDates, dateStr, instance) {
            // console.log(selectedDates);
            // // You can add additional logic here if needed
        },
        onReady: function(selectedDates, dateStr, instance) {
            // Add custom date range options to the Flatpickr container
            var datepickerContainer = instance.calendarContainer;

            var dateRangeOptions = [
                { label: 'Today', range: [new Date(), new Date()] },
                { label: 'Yesterday', range: [new Date(new Date().setDate(new Date().getDate() - 1)), new Date(new Date().setDate(new Date().getDate() - 1))] },
                { label: 'This Month', range: [new Date(new Date().getFullYear(), new Date().getMonth(), 1), new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0)] },
                { label: 'Last Month', range: [new Date(new Date().getFullYear(), new Date().getMonth() - 1, 1), new Date(new Date().getFullYear(), new Date().getMonth(), 0)] },
            ];

            dateRangeOptions.forEach(function(option) {
                var button = document.createElement('button');
                button.textContent = option.label;
                button.addEventListener('click', function() {
                    flatpickrInstance.setDate(option.range);
                    flatpickrInstance.close(); // Close Flatpickr instance
                    fetch_report();
                });

                datepickerContainer.prepend(button);
            });
        }
    });
	fetch_report();
	
	// Initialize Flatpickr
	var flatpickrInstance = flatpickr('#date_start_end', {
		mode: 'range',
		dateFormat: 'Y-m-d',
		altFormat: 'F j, Y',
		altInput: false,
		allowInput: false,
		clickOpens: true,
		onChange: function(selectedDates, dateStr, instance) {
			// console.log(selectedDates);
			// // You can add additional logic here if needed
		},
		onReady: function(selectedDates, dateStr, instance) {
			// Add custom date range options to the Flatpickr container
			var datepickerContainer = instance.calendarContainer;

			var dateRangeOptions = [
				{ label: 'Today', range: [new Date(), new Date()] },
				{ label: 'Yesterday', range: [new Date(new Date().setDate(new Date().getDate() - 1)), new Date(new Date().setDate(new Date().getDate() - 1))] },
				{ label: 'This Month', range: [new Date(new Date().getFullYear(), new Date().getMonth(), 1), new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0)] },
				{ label: 'Last Month', range: [new Date(new Date().getFullYear(), new Date().getMonth() - 1, 1), new Date(new Date().getFullYear(), new Date().getMonth(), 0)] },
			];

			dateRangeOptions.forEach(function(option) {
				var button = document.createElement('button');
				var date_start_end = document.getElementById('date_start_end');
	                
				button.textContent = option.label;
				button.addEventListener('click', function() {
					flatpickrInstance.setDate(option.range);
					flatpickrInstance.close(); // Close Flatpickr instance
					var date_value = date_start_end.value;
					
					setCookie('start_end2', date_value, 7);
                    SMColibri.spa_load("<?php echo(Wo_LoadManageLinkSettings('home')); ?>?period=" + date_value + "&project=" + project_value);
				});

				datepickerContainer.prepend(button);
			});
		}
	});
});
</script>