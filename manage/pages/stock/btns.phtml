<style>
#dataSheet_download {
	margin-right: 10px;
}
#dataSheet_download button.btn {
	border: 2px solid transparent;
	padding: 6px 2px;
	width: 40px;
	border-radius: 8px;
}
#dataSheet_download button.btn:hover {
	background: white;
	border: 2px solid #6c757d;
	color: #6c757d;
}

@media (max-width: 768px) {
	#dataSheet_download button.btn i {
		margin-right: 0px !important;
		margin-left: 0px !important;
	}
	.ai_auto {
		padding-left: 10px;
		padding-right: 10px;
	}
	
	#dataSheet_download button.btn {
		width: 30px;
	}
}
.select2-container {z-index: 9999999999999;}
</style>
<div class="ms-auto button_flex_middle">
 <div id="dataSheet_download"></div>
 	<!-- Use flatpickr for date selection -->
	<input class="form-control w-auto" type="month" id="month_year" name="month_year" placeholder="Select date range" onchange="DataTableRefresh()" style="margin-right: 10px;" value="<?php echo (!empty(urldecode($_COOKIE['month_year']))) ? urldecode($_COOKIE['month_year']) : date('Y-m'); ?>">

	<!-- Button trigger modal -->
	<button type="button" class="btn btn-primary ai_auto" data-bs-toggle="modal" data-bs-target="#add_stockItem">Add Item</button>

    <!-- Modal -->
    <div class="modal fade full_screen" id="add_stockItem" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-body">
            <form id="uploadForm" enctype="multipart/form-data">
              <div class="d-flex justify-content-between fixed_top" style="align-items: center;">
                <h3 class="mb-2 d-flex align-items-center fs-6 mr-auto" style="justify-content: space-between;width: 100%;">Add Stock Item</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="margin-top: -10px;"></button>
              </div>
    
              <div class="row row-cols-1 row-cols-lg-2 row-cols-xl-2">
                <!-- Icon dropdown -->
                <div class="col">
                  <div class="card radius-10 mb-2">
                    <div class="card-body p-2">
                      <div class="form-input">
                        <label for="icon" class="mb-0">Item Icon</label>
                        <select name="icon" id="icon" class="form-select w-100 select2-icons" required>
                          <option value="" disabled selected>Select an icon</option>
                          <?php
                          global $bx_icons;
                          foreach ($bx_icons as $icon): ?>
                            <option value="<?= $icon ?>" <?= ($icon == 'bx bx-box') ? 'selected' : '' ?> data-icon="<?= $icon ?>"><?= $icon ?></option>
                          <?php endforeach; ?>
                        </select>
                        <div class="mt-2">
                          <span>Preview: <i id="iconPreview" class="bx bx-question-mark"></i></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
    
                <!-- Item Name -->
                <div class="col">
                  <div class="card radius-10 mb-2">
                    <div class="card-body p-2">
                      <div class="form-input">
                        <label for="item_name" class="mb-0">Item Name</label>
                        <input type="text" name="item_name" id="item_name" class="form-control w-100" placeholder="Item Name" required />
                      </div>
                    </div>
                  </div>
                </div>
    
                <!-- Unit -->
                <div class="col">
                      <div class="card radius-10 mb-2">
                        <div class="card-body p-2">
                          <div class="form-input">
                            <label for="unit" class="mb-0">Unit</label>
                            <select name="unit" id="unit" class="form-select w-100" required>
                              <option value="">Select unit</option>
                              <option value="pcs">pcs</option>
                              <option value="box">box</option>
                              <option value="kg">kg</option>
                              <option value="liters">liters</option>
                              <option value="pack">pack</option>
                              <option value="dozen">dozen</option>
                              <option value="bottle">bottle</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>

    
                <!-- Quantity -->
                <div class="col">
                  <div class="card radius-10 mb-2">
                    <div class="card-body p-2">
                      <div class="form-input">
                        <label for="quantity" class="mb-0">Quantity</label>
                        <input type="number" name="quantity" id="quantity" class="form-control w-100" min="0" placeholder="Quantity" required />
                      </div>
                    </div>
                  </div>
                </div>
    
                <!-- Price -->
                <div class="col">
                  <div class="card radius-10 mb-2">
                    <div class="card-body p-2">
                      <div class="form-input">
                        <label for="price" class="mb-0">Unit Price (à§³)</label>
                        <input type="number" name="price" id="price" class="form-control w-100" min="0" step="0.01" placeholder="Unit Price" required />
                      </div>
                    </div>
                  </div>
                </div>
    
                <!-- Low Stock Threshold -->
                <div class="col">
                  <div class="card radius-10 mb-2">
                    <div class="card-body p-2">
                      <div class="form-input">
                        <label for="low_stock_threshold" class="mb-0">Low Stock Threshold</label>
                        <input type="number" name="low_stock_threshold" id="low_stock_threshold" class="form-control w-100" min="0" value="15" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
    
              <div class="fixed_bottom_space"></div>
              <br>
              <div class="d-flex gap-3 fixed_bottom">
                <input type="submit" value="Add" class="btn btn-primary mt-3 w-100">
                <input type="button" id="reset_close_form" value="Clear & Close" class="btn btn-outline-secondary mt-3 w-100">
              </div>
            </form>
    
            <pre id="uploadResult" class="mt-3"></pre>
    
            <script>
            $(function () {
              // Icon render for Select2
                function formatIcon(icon) {
                  if (!icon.id) return icon.text;
                  const iconClass = $(icon.element).data('icon');
                  const text = icon.text || $(icon.element).text();
                  return $('<span><i class="' + iconClass + ' me-1"></i>' + text + '</span>');
                }

    
                $('#add_stockItem').on('shown.bs.modal', function () {
                  $('#icon').select2({
                    width: '100%',
                    dropdownParent: $('#add_stockItem'),
                    templateResult: formatIcon,
                    templateSelection: formatIcon,
                    escapeMarkup: function(m) { return m; }
                  });
                });
                
                // Focus search input when dropdown opens
                $(document).on('select2:open', () => {
                  setTimeout(() => {
                    document.querySelector('.select2-container--open .select2-search__field')?.focus();
                  }, 0);
                });


    
              // Update preview
              $('#icon').on('change', function () {
                const selectedIcon = $(this).val();
                $('#iconPreview').attr('class', selectedIcon || 'bx bx-question-mark');
              });
    
              // Clear form + Select2 + close modal
              function resetAndClose() {
                const form = document.getElementById('uploadForm');
                if (form) form.reset();
    
                $('#icon').val('').trigger('change');
                $('#iconPreview').attr('class', 'bx bx-question-mark');
    
                const modalEl = document.getElementById('add_stockItem');
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();
              }
    
              $('#reset_close_form').on('click', resetAndClose);
    
              // Submit form
              $('#uploadForm').on('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
    
                $.ajax({
                  url: Wo_Ajax_Requests_File() + '?f=manage_stock&s=add_stock',
                  type: 'POST',
                  data: formData,
                  dataType: 'json',
                  contentType: false,
                  processData: false,
                  cache: false,
                  success: function (data) {
                    if (data.status == 200) {
                      $('#uploadResult').html(data.html || '');
                      pos5_success_noti('Item added successfully.');
                      setTimeout(() => resetAndClose(), 200);
                    } else {
                      pos4_error_noti(data.message || 'Failed to add item.');
                    }
                    DataTableRefresh();
                  },
                  error: function () {
                    pos4_error_noti('AJAX error occurred.');
                  }
                });
              });
            });
            </script>
          </div>
        </div>
      </div>
    </div>
</div>