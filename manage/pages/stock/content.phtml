<?php if (check_permission('manage-inventory') || Wo_IsAdmin() || Wo_IsModerator()) { ?>
<div class="page-breadcrumb d-flex align-items-center mb-3">
  <div class="breadcrumb-title pe-3">Advanced Stock Item Management</div>
  <?php echo Wo_LoadManagePage('stock/btns'); ?>
</div>

<!-- Your HTML code starts here -->
<div class="card radius-10 w-100 no_border">
    <div class="card-body">
        <div class="table-responsive mt-2">
            <table id="invoiceTable" class="table align-middle mb-0" style="width: 100%;">
                <thead class="table-light">
                    <tr>
                        <th>Item Name</th>
                        <th class="hide_in_print">Unit</th>
                        <th>Prev. Stock</th>
                        <th>Used Stock</th>
                        <th>Curr. Stock</th>
                        <th class="hide_in_print">Price</th>
                        <th class="hide_in_print">Last Updated</th>
						<?php if (Wo_IsAdmin() || Wo_IsModerator()) { ?>
                        <th style="width: 60px;" class="hide_in_print">Actions</th>
						<?php } ?>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function deleteStock(id) {
  if (!id) return;
  if (!confirm('Are you sure you want to permanently delete this stock item?')) {
    return;
  }

  $.ajax({
    type: 'POST',
    url: Wo_Ajax_Requests_File() + '?f=manage_stock&s=delete_stock',
    data: { id: id },
    dataType: 'json',
    success: function(res) {
      if (res.status === 200) {
        // Refresh the DataTable in-place
        if (typeof DataTableRefresh === 'function') {
          DataTableRefresh();
        }
      } else {
        pos4_error_noti(res.message || 'Delete failed');
      }
    },
    error: function() {
      pos4_error_noti('AJAX error while deleting stock.');
    }
  });
}

function edit_entry_modal(id) {
    if (id == null) {
        return false;
    }
		var project = $('#project').val();
		
    $.ajax({
        type: "POST",
        url: Wo_Ajax_Requests_File() + '?f=manage_stock&s=edit_modal',
        data: {
            id: id,
            project: project
        },
        success: function (response) {
            if (response['status'] == 200) {
				$("#contnet").append(response['result']);
				$("#updateStock-modal").modal('show');
            }
        }
    });
}
$(document).ready(function() {
    
    // Add event listener for row click to trigger the edit_entry_modal(id) function
    $('#invoiceTable tbody').on('click', 'tr', function() {
        var id = $(this).data('id');
        if (id) {
            edit_entry_modal(id);
        }
    });
    
    // Initialize DataTables without buttons
    var table = $('#invoiceTable').DataTable({
        "processing": true,
		"serverSide": true,
        "pageLength": 100,  // Set the default number of entries per page
        "ajax": {
            "url": Wo_Ajax_Requests_File() + '?f=manage_stock&s=fetch',
            "type": "POST",
			"data": function (d) {
				// Include additional parameters for the AJAX request
				var month_year = document.getElementById('month_year').value;
				d.month_year = month_year;
			},
            "beforeSend": function(xhr) {
				$('#length_count').remove();
				$('#invoiceTable_length label').append('<span id="length_count"><span>');
                // Set opacity to 0 before the Ajax request
                $('#invoiceTable').css('opacity', .5);
            },
            "complete": function(xhr) {
				// Parse the JSON response
				var responseData = JSON.parse(xhr.responseText);
				// Access the recordsTotal value
				var recordsTotal = responseData.recordsTotal;
					
                // Set opacity to 1 after the Ajax request is complete
                $('#invoiceTable').css('opacity', 1);
                $('#length_count').html('of <b>' + recordsTotal + '</b>');
            }
        },
        "columns": [
            { "data": "item", "orderable": true },
            { "data": "unit", "orderable": false },
            { "data": "prev_stock", "orderable": false },
            { "data": "used_stock", "orderable": false },
            { "data": "quantity", "orderable": false },
            { "data": "price", "orderable": false },
            { "data": "last_update", "orderable": false },
			<?php if (Wo_IsAdmin() || Wo_IsModerator()) { ?>
            { "data": "actions", "orderable": false },
			<?php } ?>
        ],
        "order": [],
        "language": {
            "emptyTable": "No data available in the table",
            "infoEmpty": "Showing 0 to 0 of 0 entries",
            "infoFiltered": "(filtered from _MAX_ total entries)",
            "zeroRecords": "No matching records found"
        },
		"rowCallback": function(row, data) {
			$(row).attr('data-id', data.id);
			if (data.quantity < data.stock_threshold) {
			    $(row).addClass('low_stock');
			}
		}
    });
	
	<?php if (Wo_IsAdmin() || Wo_IsModerator() || check_permission('manage-leads')) { ?>
	<?php } else { ?>
		$('#user_id').change(function() {
			var user_id = $(this).val(); // Get the selected value from #user_id

			// Compare selected user_id with PHP variable $wo['user']['user_id']
			if (user_id == <?php echo $wo['user']['user_id']; ?>) {
				table.column(':last').visible(true); // Show the last column of DataTable
			} else {
				table.column(':last').visible(false); // Hide the last column of DataTable
			}
		});
	<?php } ?>
    // Append buttons separately
    new $.fn.dataTable.Buttons(table, {
        buttons: [
            { 
                extend: 'copy',
                text: '<i class="fadeIn animated bx bx-copy"></i>',
                titleAttr: 'Copy to clipboard',
                exportOptions: {
                    columns: function(idx, data, node) {
                        return !$(node).hasClass('hide_in_print');
                    }
                }
            },
            { 
                extend: 'excel',
                text: '<svg xmlns="http://www.w3.org/2000/svg" width="15" height="18" viewBox="0 0 18 24"><path fill="currentColor" d="M20.34,4.59,16.41.66A2.28,2.28,0,0,0,14.82,0H5.25A2.25,2.25,0,0,0,3,2.25v19.5A2.25,2.25,0,0,0,5.25,24h13.5A2.25,2.25,0,0,0,21,21.75V6.19A2.27,2.27,0,0,0,20.34,4.59ZM18.57,6H15V2.44ZM5.25,21.75V2.25h7.5V7.13a1.12,1.12,0,0,0,1.12,1.12h4.88v13.5ZM15.19,10.5H13.84a.55.55,0,0,0-.49.3A24.54,24.54,0,0,0,12,13.5c-.65-1.36-.32-.81-1.34-2.7a.56.56,0,0,0-.49-.3H8.81a.56.56,0,0,0-.48.85L10.5,15,8.33,18.66a.56.56,0,0,0,.48.84h1.36a.56.56,0,0,0,.49-.29A23.15,23.15,0,0,0,12,16.5c.7,1.42.28.75,1.34,2.71a.57.57,0,0,0,.5.29h1.35a.56.56,0,0,0,.48-.84L13.5,15c0-.05,1.42-2.36,2.17-3.65A.56.56,0,0,0,15.19,10.5Z" transform="translate(-3)"/></svg>', // Font Awesome Excel icon
                titleAttr: 'Export to Excel',
                exportOptions: {
                    columns: function(idx, data, node) {
                        return !$(node).hasClass('hide_in_print');
                    }
                }
            },
            { 
                extend: 'pdf',
                text: '<i class="fadeIn animated bx bxs-file-pdf"></i>',
                titleAttr: 'Export to PDF',
                exportOptions: {
                    columns: function(idx, data, node) {
                        return !$(node).hasClass('hide_in_print');
                    }
                }
            },
            { 
                extend: 'print',
                text: '<i class="fadeIn animated bx bx-printer"></i>',
                titleAttr: 'Print',
                exportOptions: {
                    columns: function(idx, data, node) {
                        return !$(node).hasClass('hide_in_print');
                    }
                }
            }
        ]
    }).container().appendTo('#dataSheet_download');
	
    // DataTableReset function to reset the DataTable
    window.DataTableReset = function() {
        table.ajax.reload();
    };
	
	window.DataTableRefresh = function() {
		table.ajax.reload(null, false); // Reload the DataTable

		// After reload, restore the state (including pagination)
		var state = table.state.loaded();
		if (state) {
			table.state.restore(state);
		}
	};
});
</script>
<?php } else { echo Wo_LoadManagePage('permission-required/content'); } ?>
