<!-- Change Plot Modal Component -->
<div class="modal fade" id="changePlotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-warning text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-shuffle me-2"></i>Change Plot Assignment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body py-4">
        <div class="text-center mb-4">
          <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
            <i class="lni lni-shuffle text-warning" style="font-size: 24px;"></i>
          </div>
        </div>

        <input type="hidden" id="change_plot_purchase_id" value="">
        
        <!-- Current Plot Information -->
        <div class="card border-0 bg-light mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">
              <i class="lni lni-home me-2"></i>Current Plot Information
            </h6>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Project</label>
                <input type="text" id="current_project" class="form-control" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Block</label>
                <input type="text" id="current_block" class="form-control" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Plot</label>
                <input type="text" id="current_plot" class="form-control" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Katha</label>
                <input type="text" id="current_katha" class="form-control" readonly>
              </div>
            </div>
          </div>
        </div>

        <!-- New Plot Selection -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">
              <i class="lni lni-map me-2"></i>Select New Plot
            </h6>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-medium">
                  <i class="lni lni-building me-1"></i>Project
                </label>
                <select id="new_project_select" class="form-control">
                  <option value="">Select Project</option>
                  <?php 
                  global $db;
                  foreach ($db->orderBy('id', 'ASC')->get(T_PROJECTS) as $proj): ?>
                    <option value="<?= htmlspecialchars($proj->slug, ENT_QUOTES) ?>"><?= htmlspecialchars($proj->name) ?></option>
                  <?php endforeach; ?>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-medium">
                  <i class="lni lni-map-marker me-1"></i>Available Plots
                </label>
                <select id="new_plot_select" class="form-control">
                  <option value="">First select a project</option>
                </select>
                <small class="form-text text-muted mt-1">Search by: block, plot number, katha, road</small>
              </div>
            </div>

            <!-- Plot Details (shown after selection) -->
            <div id="new_plot_details" class="mt-3" style="display:none;">
              <div class="alert alert-success">
                <strong>Selected Plot Details:</strong> Review the information below before confirming the change.
              </div>
              
              <div class="row g-2">
                <div class="col-md-2">
                  <label class="form-label fw-medium">Block</label>
                  <input type="text" id="new_detail_block" class="form-control" readonly>
                </div>
                <div class="col-md-2">
                  <label class="form-label fw-medium">Plot</label>
                  <input type="text" id="new_detail_plot" class="form-control" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-medium">Road</label>
                  <input type="text" id="new_detail_road" class="form-control" readonly>
                </div>
                <div class="col-md-2">
                  <label class="form-label fw-medium">Katha</label>
                  <input type="text" id="new_detail_katha" class="form-control" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-medium">Facing</label>
                  <input type="text" id="new_detail_facing" class="form-control" readonly>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label fw-medium">
                <i class="lni lni-pencil me-1"></i>Reason for Change <span class="text-danger">*</span>
              </label>
              <textarea id="change_plot_reason" class="form-control" rows="3" placeholder="Enter detailed reason for plot change..." required></textarea>
              <small class="form-text text-muted">Provide a clear reason for audit and future reference.</small>
            </div>

            <div class="alert alert-warning mt-3">
              <div class="d-flex align-items-start">
                <i class="lni lni-warning text-warning me-2" style="font-size: 20px; margin-top: 2px;"></i>
                <div>
                  <strong>Important:</strong> Changing the plot will update all related records and may affect payment calculations. 
                  This action will be logged for audit purposes.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-danger d-none" id="change_plot_error" role="alert"></div>
      </div>

      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="lni lni-close me-1"></i>Cancel
        </button>
        <button id="change_plot_save" class="btn btn-warning text-white">
          <i class="lni lni-shuffle me-1"></i>Change Plot
        </button>
      </div>
    </div>
  </div>
</div>

<script>
jQuery(function($){
  'use strict';

  // Initialize change plot functionality
  function initChangePlot() {
    // Global change plot function
    window.changePlot = function(purchaseId) {
      $('#change_plot_purchase_id').val(purchaseId);
      $('#change_plot_error').addClass('d-none').text('');
      $('#change_plot_reason').val('');
      $('#new_plot_details').hide();
      
      // Load current plot details
      loadCurrentPlotDetails(purchaseId);
      
      $('#changePlotModal').modal('show');
    };

    // Make changePlot available for dropdown menu
    $(document).off('click.changePlot', '.change_plot_btn').on('click.changePlot', '.change_plot_btn', function(e){
      e.preventDefault();
      var purchaseId = $(this).data('id');
      if (purchaseId) {
        changePlot(purchaseId);
      }
    });

    // Project change handler
    $('#new_project_select').off('change').on('change', function(){
      var projectSlug = $(this).val();
      $('#new_plot_details').hide();
      
      if (!projectSlug) {
        $('#new_plot_select').html('<option value="">First select a project</option>');
        return;
      }

      // Load available plots for selected project
      loadAvailablePlots(projectSlug);
    });

    // Plot selection handler
    $('#new_plot_select').off('change').on('change', function(){
      var plotId = $(this).val();
      if (plotId) {
        var selectedOption = $(this).find('option:selected');
        var plotData = selectedOption.data();
        
        if (plotData) {
          populateNewPlotDetails(plotData);
          $('#new_plot_details').show();
        }
      } else {
        $('#new_plot_details').hide();
      }
    });

    // Change plot save handler
    $('#change_plot_save').off('click').on('click', function(){
      var purchaseId = $('#change_plot_purchase_id').val();
      var newPlotId = $('#new_plot_select').val();
      var reason = $('#change_plot_reason').val().trim();
      
      // Validation
      var errors = [];
      if (!newPlotId) errors.push('Please select a new plot.');
      if (!reason) errors.push('Please provide a reason for the plot change.');
      if (reason && reason.length < 10) errors.push('Reason must be at least 10 characters long.');
      
      if (errors.length > 0) {
        $('#change_plot_error').removeClass('d-none').html(errors.join('<br>'));
        return;
      }
      
      // Confirm action
      if (!confirm('Are you sure you want to change the plot assignment? This action cannot be undone.')) {
        return;
      }
      
      var $btn = $(this);
      $btn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Changing...');
      
      var payload = {
        s: 'change_plot',
        purchase_id: purchaseId,
        new_plot_id: newPlotId,
        reason: reason
      };
      
      $.post(Wo_Ajax_Requests_File() + '?f=manage_inventory', payload)
        .done(function(response){
          var data = typeof response === 'string' ? JSON.parse(response) : response;
          
          if (data && (data.status === 200 || data.status === '200')) {
            $('#changePlotModal').modal('hide');
            
            // Show success message
            var $alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
              '<i class="lni lni-checkmark me-2"></i>Plot has been changed successfully.' +
              '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
              '</div>');
            
            $('#client_details').prepend($alert);
            
            setTimeout(function(){
              location.reload(); // Refresh to show updated data
            }, 2000);
            
          } else {
            var errorMsg = (data && data.message) ? data.message : 'Failed to change plot';
            $('#change_plot_error').removeClass('d-none').text(errorMsg);
          }
        })
        .fail(function(){
          $('#change_plot_error').removeClass('d-none').text('Server error occurred. Please try again.');
        })
        .always(function(){
          $btn.prop('disabled', false).html('<i class="lni lni-shuffle me-1"></i>Change Plot');
        });
    });

    // Auto-resize textarea
    $('#change_plot_reason').on('input', function(){
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  }

  function loadCurrentPlotDetails(purchaseId) {
    $.get(Wo_Ajax_Requests_File() + '?f=manage_inventory&s=get_purchase_details&id=' + purchaseId)
      .done(function(response){
        var data = typeof response === 'string' ? JSON.parse(response) : response;
        
        if (data && data.status === 200 && data.purchase) {
          var purchase = data.purchase;
          $('#current_project').val(purchase.project || '-');
          $('#current_block').val(purchase.block || '-');
          $('#current_plot').val(purchase.plot || '-');
          $('#current_katha').val(purchase.katha || '-');
        }
      })
      .fail(function(){
        console.warn('Failed to load current plot details');
      });
  }

  function loadAvailablePlots(projectSlug) {
    $('#new_plot_select').html('<option value="">Loading plots...</option>');
    
    $.get(Wo_Ajax_Requests_File() + '?f=booking&s=get_available_plots&project_slug=' + encodeURIComponent(projectSlug))
      .done(function(response){
        var plots = Array.isArray(response) ? response : [];
        
        $('#new_plot_select').empty().append('<option value="">Choose available plot...</option>');
        
        if (plots.length > 0) {
          plots.forEach(function(plot){
            var displayText = 'Block ' + (plot.block || 'N/A') + 
                            ', Plot ' + (plot.plot || 'N/A') + 
                            ', ' + (plot.katha || 'N/A') + ' katha';
            if (plot.road) displayText += ', Road ' + plot.road;
            
            var $option = $('<option></option>')
              .attr('value', plot.id)
              .text(displayText)
              .data(plot);
            
            $('#new_plot_select').append($option);
          });
        } else {
          $('#new_plot_select').append('<option value="" disabled>No available plots found</option>');
        }
      })
      .fail(function(){
        $('#new_plot_select').html('<option value="" disabled>Failed to load plots</option>');
      });
  }

  function populateNewPlotDetails(plotData) {
    $('#new_detail_block').val(plotData.block || '');
    $('#new_detail_plot').val(plotData.plot || '');
    $('#new_detail_road').val(plotData.road || '');
    $('#new_detail_katha').val(plotData.katha || '');
    $('#new_detail_facing').val(plotData.facing || '');
  }

  // Add to global initialization
  if (typeof window.initViewClientComponents !== 'function') {
    window.initViewClientComponents = function() {
      initChangePlot();
    };
  } else {
    var originalInit = window.initViewClientComponents;
    window.initViewClientComponents = function() {
      originalInit();
      initChangePlot();
    };
  }

  // Cleanup
  $('#viewClient-modal').on('hidden.bs.modal.changePlot', function(){
    $(document).off('.changePlot');
  });

});
</script>