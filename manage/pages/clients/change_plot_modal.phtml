<!-- Simplified Change Plot Modal Component -->
<div class="modal fade" id="changePlotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-warning text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-shuffle me-2"></i>Change Plot Assignment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body py-4">
        <div class="text-center mb-4">
          <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
            <i class="lni lni-shuffle text-warning" style="font-size: 24px;"></i>
          </div>
        </div>

        <input type="hidden" id="change_plot_purchase_id" value="">
        
        <!-- Current Plot Information -->
        <div class="card border-0 bg-light mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">
              <i class="lni lni-home me-2"></i>Current Plot Information
            </h6>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Project</label>
                <input type="text" id="current_project" class="form-control" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Block</label>
                <input type="text" id="current_block" class="form-control" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Plot</label>
                <input type="text" id="current_plot" class="form-control" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-medium">Current Katha</label>
                <input type="text" id="current_katha" class="form-control" readonly>
              </div>
            </div>
          </div>
        </div>

        <!-- Simplified New Plot Selection -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">
              <i class="lni lni-map me-2"></i>Select New Plot
            </h6>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-medium">
                  <i class="lni lni-building me-1"></i>Project
                </label>
                <select id="new_project_select" class="form-control">
                  <option value="">Select Project</option>
                  <?php 
                  global $db;
                  foreach ($db->orderBy('id', 'ASC')->get(T_PROJECTS) as $proj): ?>
                    <option value="<?= htmlspecialchars($proj->slug, ENT_QUOTES) ?>"><?= htmlspecialchars($proj->name) ?></option>
                  <?php endforeach; ?>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-medium">
                  <i class="lni lni-map-marker me-1"></i>Available Plots
                </label>
                <select id="new_plot_select" class="form-control">
                  <option value="">First select a project</option>
                </select>
                <small class="form-text text-muted mt-1">Search by: block, plot number, katha, road</small>
              </div>
            </div>

            <!-- Plot Details (shown after selection) -->
            <div id="new_plot_details" class="mt-3" style="display:none;">
              <div class="alert alert-success">
                <strong>Selected Plot Details:</strong> Review the information below before confirming the change.
              </div>
              
              <div class="row g-2">
                <div class="col-md-2">
                  <label class="form-label fw-medium">Block</label>
                  <input type="text" id="new_detail_block" class="form-control" readonly>
                </div>
                <div class="col-md-2">
                  <label class="form-label fw-medium">Plot</label>
                  <input type="text" id="new_detail_plot" class="form-control" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-medium">Road</label>
                  <input type="text" id="new_detail_road" class="form-control" readonly>
                </div>
                <div class="col-md-2">
                  <label class="form-label fw-medium">Katha</label>
                  <input type="text" id="new_detail_katha" class="form-control" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-medium">Facing</label>
                  <input type="text" id="new_detail_facing" class="form-control" readonly>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label fw-medium">
                <i class="lni lni-pencil me-1"></i>Reason for Change <span class="text-danger">*</span>
              </label>
              <textarea id="change_plot_reason" class="form-control" rows="3" placeholder="Enter detailed reason for plot change..." required></textarea>
              <small class="form-text text-muted">Provide a clear reason for audit and future reference.</small>
            </div>

            <div class="alert alert-warning mt-3">
              <div class="d-flex align-items-start">
                <i class="lni lni-warning text-warning me-2" style="font-size: 20px; margin-top: 2px;"></i>
                <div>
                  <strong>Important:</strong> Changing the plot will update all related records and may affect payment calculations. 
                  This action will be logged for audit purposes.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-danger d-none" id="change_plot_error" role="alert"></div>
      </div>

      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="lni lni-close me-1"></i>Cancel
        </button>
        <button id="change_plot_save" class="btn btn-warning text-white">
          <i class="lni lni-shuffle me-1"></i>Change Plot
        </button>
      </div>
    </div>
  </div>
</div>

<script>
jQuery(function($){
  'use strict';

  var bsChangePlotModal = null;
  var searchCache = {};

  // Initialize change plot functionality
  function initChangePlot() {
    // Initialize Bootstrap modal
    try {
      var modalEl = document.getElementById('changePlotModal');
      if (modalEl) {
        bsChangePlotModal = new bootstrap.Modal(modalEl, { backdrop: 'static' });
      }
    } catch(e) {
      console.warn('Bootstrap modal initialization failed:', e);
    }

    // Global change plot function
    window.changePlot = function(purchaseId) {
      $('#change_plot_purchase_id').val(purchaseId);
      $('#change_plot_error').addClass('d-none').text('');
      $('#change_plot_reason').val('');
      $('#new_plot_details').hide();
      
      // Reset selects
      $('#new_project_select').val('').trigger('change');
      $('#new_plot_select').html('<option value="">First select a project</option>');
      
      // Load current plot details
      loadCurrentPlotDetails(purchaseId);
      
      if (bsChangePlotModal) {
        bsChangePlotModal.show();
      } else {
        $('#changePlotModal').modal('show');
      }
    };

    // Make changePlot available for dropdown menu
    $(document).off('click.changePlot', '.change_plot_btn').on('click.changePlot', '.change_plot_btn', function(e){
      e.preventDefault();
      var purchaseId = $(this).data('id');
      if (purchaseId) {
        changePlot(purchaseId);
      }
    });

    // Project change handler with enhanced Select2
    $('#new_project_select').off('change').on('change', function(){
      var projectSlug = $(this).val();
      $('#new_plot_details').hide();
      
      // Destroy existing Select2 instance
      try {
        if ($('#new_plot_select').hasClass('select2-hidden-accessible')) {
          $('#new_plot_select').select2('destroy');
        }
      } catch(e) {}
      
      if (!projectSlug) {
        $('#new_plot_select').html('<option value="">First select a project</option>');
        return;
      }

      // Initialize Select2 with AJAX for plot selection (same as add_purchase_form)
      $('#new_plot_select').select2({
        dropdownParent: $('#changePlotModal'),
        placeholder: 'Search plots (block/plot/katha/road)...',
        allowClear: true,
        minimumInputLength: 0,
        closeOnSelect: true,
        width: '100%',
        ajax: {
          url: Wo_Ajax_Requests_File() + '?f=manage_inventory&s=search_purchases',
          dataType: 'json',
          delay: 300,
          cache: true,
          data: function (params) {
            return {
              q: params.term || '',
              page: params.page || 1,
              per_page: 30,
              project_id: projectSlug,
              available_only: true // Only show available plots
            };
          },
          processResults: function (data, params) {
            try {
              var rows = [];
              if (data && Array.isArray(data.data)) {
                rows = data.data;
              } else if (Array.isArray(data)) {
                rows = data;
              }

              var mapped = rows.map(function(item) {
                return normalizePlotItem(item);
              }).filter(function(item) {
                return item && item.available !== false; // Only available plots
              });

              return {
                results: mapped,
                pagination: { more: !!data.more }
              };
            } catch (e) {
              console.error('processResults error:', e);
              return { results: [], pagination: { more: false } };
            }
          }
        },
        templateResult: function(item) {
          if (!item || !item.id) return item && item.text ? item.text : null;
          
          var $wrap = $('<div class="select2-result-item d-flex justify-content-between align-items-center"></div>');
          var $label = $('<div class="select2-main-text flex-grow-1"></div>').text(item.text);
          $wrap.append($label);

          if (item.status_label) {
            var badgeClass = getBadgeClass(item.status);
            var $badge = $('<span class="select2-result-badge ' + badgeClass + '"></span>').text(item.status_label);
            $wrap.append($badge);
          }

          return $wrap;
        },
        templateSelection: function(item) {
          return item && item.text ? item.text : null;
        }
      });
    });

    // Plot selection handler
    $('#new_plot_select').off('select2:select').on('select2:select', function(e){
      var item = e.params && e.params.data ? e.params.data : null;
      if (item) {
        populateNewPlotDetails(item);
        $('#new_plot_details').show();
      }
    });

    // Change plot save handler
    $('#change_plot_save').off('click').on('click', function(){
      var purchaseId = $('#change_plot_purchase_id').val();
      var newPlotId = $('#new_plot_select').val();
      var reason = $('#change_plot_reason').val().trim();
      
      // Validation
      var errors = [];
      if (!newPlotId) errors.push('Please select a new plot.');
      if (!reason) errors.push('Please provide a reason for the plot change.');
      if (reason && reason.length < 10) errors.push('Reason must be at least 10 characters long.');
      
      if (errors.length > 0) {
        $('#change_plot_error').removeClass('d-none').html(errors.join('<br>'));
        return;
      }
      
      // Confirm action
      if (!confirm('Are you sure you want to change the plot assignment? This action cannot be undone.')) {
        return;
      }
      
      var $btn = $(this);
      $btn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Changing...');
      
      var payload = {
        purchase_id: purchaseId,
        new_plot_id: newPlotId,
        reason: reason
      };
      
      $.post(Wo_Ajax_Requests_File() + '?f=manage_inventory&s=change_plot', payload)
        .done(function(response){
          var data = typeof response === 'string' ? JSON.parse(response) : response;
          
          if (data && (data.status === 200 || data.status === '200')) {
            if (bsChangePlotModal) {
              bsChangePlotModal.hide();
            } else {
              $('#changePlotModal').modal('hide');
            }
            
            // Show success message
            var $alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
              '<i class="lni lni-checkmark me-2"></i>Plot has been changed successfully.' +
              '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
              '</div>');
            
            $('#client_details').prepend($alert);
            
            setTimeout(function(){
              location.reload(); // Refresh to show updated data
            }, 2000);
            
          } else {
            var errorMsg = (data && data.message) ? data.message : 'Failed to change plot';
            $('#change_plot_error').removeClass('d-none').text(errorMsg);
          }
        })
        .fail(function(){
          $('#change_plot_error').removeClass('d-none').text('Server error occurred. Please try again.');
        })
        .always(function(){
          $btn.prop('disabled', false).html('<i class="lni lni-shuffle me-1"></i>Change Plot');
        });
    });

    // Auto-resize textarea
    $('#change_plot_reason').on('input', function(){
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  }

  // Helper functions
  function normalizePlotItem(item) {
    if (!item) return null;
    
    var id = item.id || item.purchase_id || '';
    var plot = item.plot || item.plot_number || '';
    var katha = (item.katha !== undefined) ? String(item.katha) : '';
    var block = item.block || item.block_name || '';
    var road = item.road || item.road_name || '';
    var facing = item.facing || '';
    var status = item.status || '';
    var statusLabel = item.status_label || getStatusLabel(status);
    var available = item.available === 1 || item.available === true;

    var parts = [];
    if (block) parts.push('Block ' + String(block).toUpperCase());
    if (plot) parts.push('Plot ' + String(plot));
    if (katha) parts.push(String(katha) + ' katha');
    if (road) parts.push('Road ' + String(road));
    if (facing) parts.push('Facing ' + String(facing));

    return {
      id: id,
      text: parts.join(' • ') || String(id),
      plot: plot,
      katha: katha,
      block: block,
      road: road,
      facing: facing,
      status: status,
      status_label: statusLabel,
      available: available,
      blocked: !available,
      raw: item
    };
  }

  function getStatusLabel(status) {
    var s = String(status).toLowerCase();
    if (s === '0' || s === '1' || s === 'available') return 'Available';
    if (s === '2' || s === 'sold' || s === 'booked') return 'Sold';
    if (s === '3' || s === 'complete') return 'Complete';
    if (s === '4' || s.indexOf('cancel') !== -1) return 'Cancelled';
    return s ? (s.charAt(0).toUpperCase() + s.slice(1)) : '';
  }

  function getBadgeClass(status) {
    var s = String(status || '').toLowerCase();
    if (/(sold|2|booked)/.test(s)) return 'sold';
    if (/(cancel|4)/.test(s)) return 'cancelled';
    if (/(complete|3)/.test(s)) return 'completed';
    if (/(available|0|1)/.test(s)) return 'available';
    return 'other';
  }

  function loadCurrentPlotDetails(purchaseId) {
    $.get(Wo_Ajax_Requests_File() + '?f=manage_inventory&s=get_purchase_details&id=' + purchaseId)
      .done(function(response){
        var data = typeof response === 'string' ? JSON.parse(response) : response;
        
        if (data && data.status === 200 && data.purchase) {
          var purchase = data.purchase;
          $('#current_project').val(purchase.project || '-');
          $('#current_block').val(purchase.block || '-');
          $('#current_plot').val(purchase.plot || '-');
          $('#current_katha').val(purchase.katha || '-');
        }
      })
      .fail(function(){
        console.warn('Failed to load current plot details');
      });
  }

  function populateNewPlotDetails(plotData) {
    $('#new_detail_block').val(plotData.block || '');
    $('#new_detail_plot').val(plotData.plot || '');
    $('#new_detail_road').val(plotData.road || '');
    $('#new_detail_katha').val(plotData.katha || '');
    $('#new_detail_facing').val(plotData.facing || '');
  }

  // Add to global initialization
  if (typeof window.initViewClientComponents !== 'function') {
    window.initViewClientComponents = function() {
      initChangePlot();
    };
  } else {
    var originalInit = window.initViewClientComponents;
    window.initViewClientComponents = function() {
      originalInit();
      initChangePlot();
    };
  }

  // Cleanup
  $('#viewClient-modal').on('hidden.bs.modal.changePlot', function(){
    if (bsChangePlotModal) {
      try {
        bsChangePlotModal.dispose();
        bsChangePlotModal = null;
      } catch(e) {}
    }
    
    // Destroy Select2 instances
    try {
      if ($('#new_project_select').hasClass('select2-hidden-accessible')) {
        $('#new_project_select').select2('destroy');
      }
      if ($('#new_plot_select').hasClass('select2-hidden-accessible')) {
        $('#new_plot_select').select2('destroy');
      }
    } catch(e) {}
    
    $(document).off('.changePlot');
    searchCache = {};
  });

});
</script>