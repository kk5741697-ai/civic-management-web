<!-- Print Schedule Template Component -->
<div class="modal fade" id="printScheduleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-primary text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-printer me-2"></i>Print Payment Schedule
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="print_schedule_purchase_id" value="">
        
        <!-- Print Options -->
        <div class="card border-0 bg-light mb-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Print Options</h6>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="include_client_info" checked>
                  <label class="form-check-label" for="include_client_info">
                    Include Client Information
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="include_plot_details" checked>
                  <label class="form-check-label" for="include_plot_details">
                    Include Plot Details
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="include_payment_summary" checked>
                  <label class="form-check-label" for="include_payment_summary">
                    Include Payment Summary
                  </label>
                </div>
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show_paid_only">
                  <label class="form-check-label" for="show_paid_only">
                    Show Paid Installments Only
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show_pending_only">
                  <label class="form-check-label" for="show_pending_only">
                    Show Pending Installments Only
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Print Preview -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light border-0 py-3">
            <h6 class="mb-0 fw-semibold">
              <i class="lni lni-eye me-2"></i>Print Preview
            </h6>
          </div>
          <div class="card-body">
            <div id="schedule_print_preview" class="schedule-print-template">
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading schedule preview...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="lni lni-close me-1"></i>Cancel
        </button>
        <button type="button" id="preview_schedule_btn" class="btn btn-info">
          <i class="lni lni-eye me-1"></i>Update Preview
        </button>
        <button type="button" id="print_schedule_btn" class="btn btn-primary">
          <i class="lni lni-printer me-1"></i>Print Schedule
        </button>
      </div>
    </div>
  </div>
</div>

<script>
jQuery(function($){
  'use strict';

  var bsPrintScheduleModal = null;

  // Initialize print schedule functionality
  function initPrintSchedule() {
    try {
      var modalEl = document.getElementById('printScheduleModal');
      if (modalEl) {
        bsPrintScheduleModal = new bootstrap.Modal(modalEl);
      }
    } catch(e) {
      console.warn('Bootstrap modal initialization failed:', e);
    }

    // Global function to open print schedule modal
    window.printPaymentSchedule = function(purchaseId) {
      $('#print_schedule_purchase_id').val(purchaseId);
      loadSchedulePreview(purchaseId);
      
      if (bsPrintScheduleModal) {
        bsPrintScheduleModal.show();
      } else {
        $('#printScheduleModal').modal('show');
      }
    };

    // Make printPaymentSchedule available for dropdown menu
    $(document).off('click.printSchedule', '.print_payment_schedule').on('click.printSchedule', '.print_payment_schedule', function(e){
      e.preventDefault();
      var purchaseId = $(this).data('id');
      if (purchaseId) {
        printPaymentSchedule(purchaseId);
      }
    });

    // Preview update handler
    $('#preview_schedule_btn').off('click').on('click', function(){
      var purchaseId = $('#print_schedule_purchase_id').val();
      if (purchaseId) {
        loadSchedulePreview(purchaseId);
      }
    });

    // Print handler
    $('#print_schedule_btn').off('click').on('click', function(){
      printScheduleDocument();
    });

    // Filter change handlers
    $('#show_paid_only, #show_pending_only').off('change').on('change', function(){
      if ($(this).prop('checked')) {
        var otherId = $(this).attr('id') === 'show_paid_only' ? '#show_pending_only' : '#show_paid_only';
        $(otherId).prop('checked', false);
      }
      
      var purchaseId = $('#print_schedule_purchase_id').val();
      if (purchaseId) {
        loadSchedulePreview(purchaseId);
      }
    });

    $('#include_client_info, #include_plot_details, #include_payment_summary').off('change').on('change', function(){
      var purchaseId = $('#print_schedule_purchase_id').val();
      if (purchaseId) {
        loadSchedulePreview(purchaseId);
      }
    });
  }

  function loadSchedulePreview(purchaseId) {
    $('#schedule_print_preview').html(`
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading schedule preview...</p>
      </div>
    `);

    var options = {
      include_client_info: $('#include_client_info').prop('checked'),
      include_plot_details: $('#include_plot_details').prop('checked'),
      include_payment_summary: $('#include_payment_summary').prop('checked'),
      show_paid_only: $('#show_paid_only').prop('checked'),
      show_pending_only: $('#show_pending_only').prop('checked')
    };

    $.post(Wo_Ajax_Requests_File() + '?f=manage_inventory&s=get_schedule_preview', {
      purchase_id: purchaseId,
      options: JSON.stringify(options)
    })
      .done(function(response){
        var data = typeof response === 'string' ? JSON.parse(response) : response;
        
        if (data && data.status === 200) {
          var previewHtml = generateSchedulePreviewHTML(data);
          $('#schedule_print_preview').html(previewHtml);
        } else {
          showPreviewError('Failed to load schedule preview: ' + (data.message || 'Unknown error'));
        }
      })
      .fail(function(){
        showPreviewError('Server error occurred while loading preview.');
      });
  }

  function generateSchedulePreviewHTML(data) {
    var html = `
      <div class="schedule-print-template">
        <div class="company-header">
          <div class="company-name">Civic Real Estate Ltd.</div>
          <div class="document-title">Payment Schedule</div>
          <div class="text-muted">Generated on ${new Date().toLocaleDateString()}</div>
        </div>
    `;

    if (data.client_info && $('#include_client_info').prop('checked')) {
      html += `
        <div class="info-section">
          <div class="info-title">Client Information</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Client Name</div>
              <div class="info-value">${data.client_info.name || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Phone</div>
              <div class="info-value">${data.client_info.phone || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Address</div>
              <div class="info-value">${data.client_info.address || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">File Number</div>
              <div class="info-value">${data.client_info.file_num || '-'}</div>
            </div>
          </div>
        </div>
      `;
    }

    if (data.plot_details && $('#include_plot_details').prop('checked')) {
      html += `
        <div class="info-section">
          <div class="info-title">Plot Details</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Project</div>
              <div class="info-value">${data.plot_details.project || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Block</div>
              <div class="info-value">${data.plot_details.block || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Plot</div>
              <div class="info-value">${data.plot_details.plot || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Katha</div>
              <div class="info-value">${data.plot_details.katha || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Road</div>
              <div class="info-value">${data.plot_details.road || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Facing</div>
              <div class="info-value">${data.plot_details.facing || '-'}</div>
            </div>
          </div>
        </div>
      `;
    }

    if (data.payment_summary && $('#include_payment_summary').prop('checked')) {
      html += `
        <div class="info-section">
          <div class="info-title">Payment Summary</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Total Price</div>
              <div class="info-value">৳${data.payment_summary.total_price || '0'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Booking Money</div>
              <div class="info-value">৳${data.payment_summary.booking_money || '0'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Down Payment</div>
              <div class="info-value">৳${data.payment_summary.down_payment || '0'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Installment Amount</div>
              <div class="info-value">৳${data.payment_summary.installment_amount || '0'}</div>
            </div>
          </div>
        </div>
      `;
    }

    // Schedule table
    html += `
      <table class="table table-bordered">
        <thead>
          <tr>
            <th class="text-center">#</th>
            <th>Date</th>
            <th class="text-end">Amount</th>
            <th class="text-center">Type</th>
            <th class="text-center">Status</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (data.schedule && Array.isArray(data.schedule)) {
      data.schedule.forEach(function(item, index) {
        var statusClass = item.paid ? 'payment-status-paid' : 'payment-status-unpaid';
        var statusBadge = item.paid ? 
          '<span class="badge bg-success">Paid</span>' : 
          '<span class="badge bg-warning">Unpaid</span>';
        var typeText = item.adjustment ? 'Yearly Adjustment' : 'Regular';
        
        html += `
          <tr class="${statusClass}">
            <td class="text-center">${index + 1}</td>
            <td>${item.date}</td>
            <td class="text-end">৳${Number(item.amount).toLocaleString()}</td>
            <td class="text-center">${typeText}</td>
            <td class="text-center">${statusBadge}</td>
          </tr>
        `;
      });
    }

    html += `
        </tbody>
        <tfoot>
          <tr class="fw-bold">
            <td colspan="2" class="text-center">Total</td>
            <td class="text-end">৳${data.schedule_total || '0'}</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    `;

    // Signature area
    html += `
      <div class="signature-area">
        <div class="signature-box">
          <div class="signature-line">Client Signature</div>
        </div>
        <div class="signature-box">
          <div class="signature-line">Authorized Signature</div>
        </div>
      </div>
    `;

    html += '</div>';
    return html;
  }

  function showPreviewError(message) {
    $('#schedule_print_preview').html(`
      <div class="alert alert-danger">
        <i class="lni lni-warning me-2"></i>
        ${message}
      </div>
    `);
  }

  function printScheduleDocument() {
    var printContent = document.getElementById('schedule_print_preview').innerHTML;
    
    if (!printContent || printContent.includes('spinner-border')) {
      alert('Please wait for the preview to load before printing.');
      return;
    }

    var printWindow = window.open('', '_blank', 'width=800,height=600');
    if (!printWindow) {
      alert('Please allow popups to print the schedule.');
      return;
    }

    var printDocument = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Payment Schedule</title>
        <style>
          body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            color: #333; 
            background: white;
          }
          .schedule-print-template { 
            background: white; 
            max-width: 800px;
            margin: 0 auto;
          }
          .company-header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #007bff; 
            padding-bottom: 20px; 
          }
          .company-name { 
            font-size: 28px; 
            font-weight: bold; 
            color: #007bff; 
            margin-bottom: 5px; 
          }
          .document-title { 
            font-size: 20px; 
            color: #666; 
            margin-bottom: 20px; 
          }
          .info-section { 
            margin-bottom: 25px; 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
          }
          .info-title { 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 8px; 
            font-size: 16px;
          }
          .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
          }
          .info-item { 
            padding: 12px; 
            background: white; 
            border-radius: 6px; 
            border: 1px solid #e9ecef;
          }
          .info-label { 
            font-weight: 600; 
            color: #666; 
            font-size: 12px; 
            text-transform: uppercase;
            margin-bottom: 4px;
          }
          .info-value { 
            color: #333; 
            font-size: 14px;
            font-weight: 500;
          }
          table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            font-size: 13px;
          }
          th, td { 
            border: 1px solid #ddd; 
            padding: 10px 8px; 
            text-align: left; 
          }
          th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: #495057;
          }
          .text-center { text-align: center; }
          .text-end { text-align: right; }
          .badge { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 11px; 
            font-weight: 600; 
            color: white;
          }
          .bg-success { background-color: #28a745; }
          .bg-warning { background-color: #ffc107; color: #212529; }
          .bg-danger { background-color: #dc3545; }
          .bg-secondary { background-color: #6c757d; }
          .signature-area { 
            margin-top: 60px; 
            display: flex; 
            justify-content: space-between; 
          }
          .signature-box { 
            text-align: center; 
            width: 200px; 
          }
          .signature-line { 
            border-top: 2px solid #333; 
            margin-top: 60px; 
            padding-top: 8px; 
            font-weight: 600;
          }
          .payment-status-paid { background-color: rgba(40, 167, 69, 0.1); }
          .payment-status-unpaid { background-color: rgba(255, 193, 7, 0.1); }
          @media print {
            body { margin: 0; padding: 15px; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
          }
        </style>
      </head>
      <body>
        ${printContent}
      </body>
      </html>
    `;

    printWindow.document.write(printDocument);
    printWindow.document.close();
    
    setTimeout(function(){
      printWindow.focus();
      printWindow.print();
      setTimeout(function(){
        printWindow.close();
      }, 1000);
    }, 500);
  }

  // Add to global initialization
  if (typeof window.initViewClientComponents !== 'function') {
    window.initViewClientComponents = function() {
      initPrintSchedule();
    };
  } else {
    var originalInit = window.initViewClientComponents;
    window.initViewClientComponents = function() {
      originalInit();
      initPrintSchedule();
    };
  }

  // Cleanup
  $('#viewClient-modal').on('hidden.bs.modal.printSchedule', function(){
    if (bsPrintScheduleModal) {
      try {
        bsPrintScheduleModal.dispose();
        bsPrintScheduleModal = null;
      } catch(e) {}
    }
    $(document).off('.printSchedule');
  });

});
</script>