<?php
$client = $purchase['client'];
$booking = $purchase['booking'];

$bg_url = '';
if ($booking['project'] === 'moon-hill') $bg_url = "/manage/pages/clients/moon-hill.jpg?version=4.4.51";
elseif ($booking['project'] === 'hill-town') $bg_url = "/manage/pages/clients/hill-town.jpg?version=4.4.51";

$proj_raw = isset($booking['project']) ? $booking['project'] : '';
$proj_raw = str_replace('-', ' ', $proj_raw);
$proj_raw = ucwords($proj_raw);
$proj_html = htmlspecialchars($proj_raw, ENT_QUOTES);
if ($proj_html === '') $proj_html = '-';
?>

<!-- Print Area -->
<section class="print_area d-none" id="print_area_<?= (int)$purchase['id'] ?>" data-purchase-id="<?= (int)$purchase['id'] ?>" style="background: url('<?= $bg_url ?>') no-repeat center center; background-size: cover;">
  <div class="invoice-layout">
    <div class="changable-content" id="changable_modal_content_<?= $index ?>">
      <?php
      if (isset($project_mapping[$booking['project']])) {
        $field_positions = $db->where('project_id', $project_mapping[$booking['project']])->get('field_positions');
        foreach ($field_positions as $fp):
          $style = json_decode($fp->style_json, true);
          $name = $fp->field_name;
          $top = $style['top'] ?? '0px';
          $left = $style['left'] ?? '0px';
          $width = $style['width'] ?? 'auto';
          $fontSize = $style['fontSize'] ?? '15px';
          $letterSpacing = $style['letterSpacing'] ?? '0px';
          $textAlign = $style['textAlign'] ?? 'left';
          $value = '';

          switch ($name) {
            case 'client_id': $value = $client['id']; break;
            case 'project_name': $value = $proj_html; break;
            case 'applicant_name': $value = $client['name']; break;
            case 'block': $value = $booking['block']; break;
            case 'plot': $value = $booking['plot']; break;
            case 'katha': $value = $booking['katha']; break;
            case 'facing': $value = $booking['facing']; break;
            case 'road': $value = $booking['road']; break;
            case 'date': $value = date('d m Y', $purchase['time']); break;
            case 'reference':
              if (!empty($wo['additional']['reference'])) {
                $refUser = Wo_UserData($wo['additional']['reference']);
                $value = $refUser['name'] ?? '';
              }
              break;
            default:
              if (!empty($wo['additional'][$name])) $value = htmlspecialchars($wo['additional'][$name]);
          }
      ?>
        <span class="<?= htmlspecialchars($name, ENT_QUOTES) ?>" style="position:absolute;top:<?= htmlspecialchars($top, ENT_QUOTES) ?>;left:<?= htmlspecialchars($left, ENT_QUOTES) ?>;width:<?= htmlspecialchars($width, ENT_QUOTES) ?>;font-size:<?= htmlspecialchars($fontSize, ENT_QUOTES) ?>;text-align:<?= htmlspecialchars($textAlign, ENT_QUOTES) ?>;letter-spacing:<?= htmlspecialchars($letterSpacing, ENT_QUOTES) ?>;white-space:normal;line-height:1.4;">
          <?= htmlspecialchars($value) ?>
        </span>
      <?php endforeach; } ?>
    </div>
  </div>
</section>

<!-- Table Row -->
<tr id="purchaseRow_<?= (int)$purchase['id'] ?>">
  <td><?= $proj_html ?></td>
  <td><?= ($booking['project'] == 'hill-town') ? htmlspecialchars(ucwords($booking['block'])) : 'N/A' ?></td>
  <td><?= htmlspecialchars($booking['katha']) ?></td>
  <td><?= htmlspecialchars($booking['plot']) ?></td>
  <td><?= htmlspecialchars($booking['road']) ?></td>
  <td><?= htmlspecialchars($booking['file_num']) ?></td>
  <td><?= htmlspecialchars(date('d M Y', $purchase['time'])) ?></td>
  <td>
    <?php
    $sr = (string)($booking['status'] ?? '');
    if ($sr === '1') echo '<span class="badge bg-info">Available</span>';
    elseif ($sr === '2') echo '<span class="badge bg-success">Sold</span>';
    elseif ($sr === '3') echo '<span class="badge bg-success">Complete</span>';
    elseif ($sr === '4') echo '<span class="badge bg-danger">Canceled</span>';
    else echo '<span class="badge bg-info">Available</span>';
    ?>
  </td>
  <td class="text-center position-static">
    <div class="dropdown dropdown-actions">
      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
              id="dropdownMenuButton<?= (int)$purchase['id'] ?>" 
              data-bs-toggle="dropdown" 
              aria-expanded="false"
              data-bs-auto-close="true">
        <i class="lni lni-more-alt"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end shadow-lg dropdown-actions-menu" 
          aria-labelledby="dropdownMenuButton<?= (int)$purchase['id'] ?>">
        <li><h6 class="dropdown-header bg-primary text-white"><i class="lni lni-cog me-1"></i> Purchase Actions</h6></li>
        <li><a class="dropdown-item print-booking-form" href="javascript:;" data-id="<?= (int)$purchase['id'] ?>"><i class="lni lni-printer me-2 text-primary"></i> Print Booking Form</a></li>
        <li><a class="dropdown-item update_installment" href="javascript:;" data-id="<?= (int)$purchase['id'] ?>"><i class="lni lni-dollar me-2 text-success"></i> Payment Schedule</a></li>
        <li><a class="dropdown-item print_payment_schedule" href="javascript:;" data-id="<?= (int)$purchase['id'] ?>"><i class="lni lni-file-text me-2 text-info"></i> Print Payment Schedule</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><h6 class="dropdown-header bg-warning text-white"><i class="lni lni-layers me-1"></i> Management</h6></li>
        <li><a class="dropdown-item change_plot_btn" href="javascript:;" data-id="<?= (int)$purchase['id'] ?>"><i class="lni lni-shuffle me-2 text-warning"></i> Change Plot</a></li>
        <li><a class="dropdown-item" href="javascript:;" onclick="transferPurchase(<?= (int)$purchase['id'] ?>)"><i class="lni lni-users me-2 text-info"></i> Transfer Purchase</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><h6 class="dropdown-header bg-info text-white"><i class="lni lni-files me-1"></i> Reports & History</h6></li>
        <li><a class="dropdown-item" href="javascript:;" onclick="viewPurchaseHistory(<?= (int)$purchase['id'] ?>)"><i class="lni lni-calendar me-2 text-info"></i> Purchase History</a></li>
        <li><a class="dropdown-item" href="javascript:;" onclick="generatePurchaseReport(<?= (int)$purchase['id'] ?>)"><i class="lni lni-stats-up me-2 text-primary"></i> Generate Report</a></li>
        <li><a class="dropdown-item" href="javascript:;" onclick="exportPurchaseData(<?= (int)$purchase['id'] ?>)"><i class="lni lni-download me-2 text-success"></i> Export Data</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><h6 class="dropdown-header bg-danger text-white"><i class="lni lni-warning me-1"></i> Critical Actions</h6></li>
        <li><a class="dropdown-item" href="javascript:;" onclick="suspendPurchase(<?= (int)$purchase['id'] ?>)"><i class="lni lni-pause me-2 text-warning"></i> Suspend Purchase</a></li>
        <li><a class="dropdown-item cancel-purchase" href="javascript:;" data-id="<?= (int)$purchase['id'] ?>"><i class="lni lni-close me-2 text-danger"></i> Cancel Purchase</a></li>
      </ul>
    </div>
  </td>
</tr>