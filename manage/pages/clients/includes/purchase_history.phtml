<!-- Purchase History -->
<div class="card border-0 shadow-sm">
  <div class="card-body p-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h6 class="mb-0">Purchase History</h6>
      <div class="small text-muted"><?php echo count($booking_helper); ?> purchases</div>
    </div>

    <?php if (!empty($booking_helper)): ?>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0" id="purchaseTable">
          <thead class="table-light">
            <tr>
              <th style="width:80px;">File #</th>
              <th>Project</th>
              <th style="width:80px;">Plot</th>
              <th style="width:100px;">Per Katha</th>
              <th style="width:100px;">Down Payment</th>
              <th style="width:80px;">Status</th>
              <th style="width:120px;">Date</th>
              <th style="width:100px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($booking_helper as $index => $purchase): 
              $booking = GetBookingById($purchase['booking_id']);
              $project = GetProjectBySlug($booking['project']);
              
              $status_badge = match ((string)$purchase['status']) {
                '1' => '<span class="badge bg-info text-dark">Available</span>',
                '2' => '<span class="badge bg-success">Sold</span>',
                '3' => '<span class="badge bg-primary">Complete</span>',
                '4' => '<span class="badge bg-danger">Canceled</span>',
                default => '<span class="badge bg-secondary text-dark">Unknown</span>',
              };
            ?>
            <tr data-purchase-id="<?php echo $purchase['id']; ?>" data-client-id="<?php echo $client['id']; ?>">
              <td class="fw-medium"><?php echo htmlspecialchars($purchase['file_num']); ?></td>
              <td><?php echo htmlspecialchars($project['name'] ?? 'Unknown'); ?></td>
              <td><?php echo htmlspecialchars($booking['plot'] ?? '-'); ?></td>
              <td>৳<?php echo number_format($purchase['per_katha'] ?? 0, 2); ?></td>
              <td>৳<?php echo number_format($purchase['down_payment'] ?? 0, 2); ?></td>
              <td><?php echo $status_badge; ?></td>
              <td><?php echo date('d M Y', $purchase['time']); ?></td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary btn-sm" onclick="openInstallmentModal(<?php echo $purchase['id']; ?>)" title="Installments">
                    <i class="bx bx-calendar"></i>
                  </button>
                  <button class="btn btn-outline-success btn-sm" onclick="printBookingForm(<?php echo $purchase['id']; ?>)" title="Print Form">
                    <i class="bx bx-printer"></i>
                  </button>
                  <?php if ($purchase['status'] != '4'): ?>
                  <button class="btn btn-outline-danger btn-sm" onclick="openCancelModal(<?php echo $purchase['id']; ?>)" title="Cancel">
                    <i class="bx bx-x"></i>
                  </button>
                  <?php endif; ?>
                </div>
              </td>
            </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      </div>
    <?php else: ?>
      <div class="text-center py-4 text-muted">
        <i class="bx bx-package" style="font-size:48px;opacity:0.3;"></i>
        <div class="mt-2">No purchases found</div>
        <button class="btn btn-sm btn-primary mt-2" onclick="openPurchaseModal()">Create First Purchase</button>
      </div>
    <?php endif; ?>

  </div>
</div>