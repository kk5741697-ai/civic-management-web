<?php
/* view_client.phtml
    Also the entire modal & it's script need clear also from window when the #viewClient-modal modal are close.
   Complete client view with enhanced payment schedule functionality and all dropdown actions
*/
Global $project_mapping;
global $db, $wo;

// Fetch users
$get_users = $db->orderBy('position', 'ASC')->where('active', '1')->where('banned', '0')->get(T_USERS);

// Totals - Fixed calculations
$clientId = $wo['client']['id'];

// Fixed total amount calculation - sum of (per_katha * katha) from booking_helper with proper joins
$total_amount = 0;
$total_purchase = 0;
try {
    $helpers = $db->rawQuery("
        SELECT bh.per_katha, b.katha 
        FROM `" . T_BOOKING_HELPER . "` bh
        JOIN `" . T_BOOKING . "` b ON b.id = bh.booking_id
        WHERE bh.client_id = ? AND bh.status != '4'
    ", [$clientId]);
    
    foreach ($helpers as $helper) {
        $per_katha = (float)($helper->per_katha ?? 0);
        $katha = (float)($helper->katha ?? 0);
        $total_amount += ($per_katha * $katha);
        $total_purchase++;
    }
} catch (Exception $e) {
    $total_amount = 0;
    $total_purchase = 0;
}

$total_paid    = (float) $db->where('customer_id', $clientId)->getValue(T_INVOICE, 'SUM(pay_amount)') ?: 0;
$total_due     = $total_amount - $total_paid;
$total_invoice = (int)   $db->where('customer_id', $clientId)->getValue(T_INVOICE, 'COUNT(*)');

//crm_nominees -> T_CRM_NOMINEES
$get_nominees = $db->where('customer_id', $clientId)->orderBy('name', 'ASC')->get(T_CRM_NOMINEES);
?>

<div class="modal fade full_screen" id="viewClient-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content border-0 shadow-lg">

      <!-- Header with modern styling -->
      <div class="modal-header no-print bg-gradient-primary text-white border-0">
        <div class="d-flex align-items-center gap-3">
          <div class="avatar rounded-circle bg-white text-primary d-flex align-items-center justify-content-center" style="width:48px;height:48px;font-weight:700;font-size:18px;">
            <?= strtoupper(substr($wo['client']['name'],0,1)) ?>
          </div>
          <div>
            <h4 class="mb-0 text-white"><?= htmlspecialchars($wo['client']['name']) ?></h4>
            <div class="text-white-50 small"><?= htmlspecialchars($wo['client']['email'] ?? '') ?></div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button id="printButton" class="btn btn-outline-light btn-sm" title="Print booking form">
            <i class="lni lni-printer me-1"></i> Print
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal" aria-label="Close">
            <i class="lni lni-close"></i>
          </button>
        </div>
      </div>

      <div class="view-container form-toggle">
        <!-- Summary Cards with modern design -->
        <section id="client_details" class="no-print mt-4 px-4">
          <div class="row g-3 mb-4">
            <?php foreach ([['Plots', number_format($total_purchase), 'cart', 'info'], ['Total', "৳".number_format($total_amount), 'bag-handle-sharp', 'primary'], ['Paid', "৳".number_format($total_paid), 'checkmark-circle', 'success'], ['Due', "৳".number_format($total_due), 'time', 'danger']] as [$title, $value, $icon, $variant]): ?>
              <div class="col-6 col-md-4 col-lg">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="card-body d-flex align-items-center p-3">
                    <div class="flex-grow-1">
                      <p class="text-muted mb-1 small fw-medium"><?= htmlspecialchars($title) ?></p>
                      <h5 class="mb-0 fw-bold"><?= htmlspecialchars($value) ?></h5>
                    </div>
                    <div class="fs-2 text-<?= $variant ?>">
                      <ion-icon name="<?= htmlspecialchars($icon) ?>"></ion-icon>
                    </div>
                  </div>
                </div>
              </div>
            <?php endforeach; ?>
          </div>

          <!-- Purchase Table with modern styling -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="mb-0 fw-semibold text-dark">Purchase Details</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="purchaseTable">
                  <thead class="table-light">
                    <tr>
                      <th class="fw-semibold">Project</th>
                      <th class="fw-semibold">Block</th>
                      <th class="fw-semibold">Katha</th>
                      <th class="fw-semibold">Plot</th>
                      <th class="fw-semibold">Road</th>
                      <th class="fw-semibold">File</th>
                      <th class="fw-semibold">Date</th>
                      <th class="fw-semibold">Status</th>
                      <th class="fw-semibold text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php
                    foreach ($wo['booking_helper'] as $index => $p):
                      $client = $p['client'];
                      $booking = $p['booking'];

                      $bg_url = '';
                      if ($booking['project'] === 'moon-hill') $bg_url = "/manage/pages/clients/moon-hill.jpg?version=4.4.51";
                      elseif ($booking['project'] === 'hill-town') $bg_url = "/manage/pages/clients/hill-town.jpg?version=4.4.51";

                      $proj_raw = isset($booking['project']) ? $booking['project'] : '';
                      $proj_raw = str_replace('-', ' ', $proj_raw);
                      $proj_raw = ucwords($proj_raw);
                      $proj_html = htmlspecialchars($proj_raw, ENT_QUOTES);
                      if ($proj_html === '') $proj_html = '-';
                    ?>
                    <!-- Booking Form (print area) -->
                    <section class="print_area d-none"
                             id="print_area_<?= (int)$p['id'] ?>"
                             data-purchase-id="<?= (int)$p['id'] ?>"
                             style="background: url('<?= $bg_url ?>') no-repeat center center; background-size: cover;">
                      <div class="invoice-layout">
                        <div class="changable-content" id="changable_modal_content_<?= $index ?>">
                          <?php
                            $field_positions = $db->where('project_id', $project_mapping[$booking['project']])->get('field_positions');
                            foreach ($field_positions as $fp):
                              $style = json_decode($fp->style_json, true);
                              $name = $fp->field_name;
                              $top = $style['top'] ?? '0px';
                              $left = $style['left'] ?? '0px';
                              $width = $style['width'] ?? 'auto';
                              $fontSize = $style['fontSize'] ?? '15px';
                              $letterSpacing = $style['letterSpacing'] ?? '0px';
                              $textAlign = $style['textAlign'] ?? 'left';
                              $value = '';

                              switch ($name) {
                                case 'client_id': $value = $client['id']; break;
                                case 'project_name': $value = $proj_html; break;
                                case 'applicant_name': $value = $client['name']; break;
                                case 'block': $value = $booking['block']; break;
                                case 'plot': $value = $booking['plot']; break;
                                case 'katha': $value = $booking['katha']; break;
                                case 'facing': $value = $booking['facing']; break;
                                case 'road': $value = $booking['road']; break;
                                case 'date': $value = date('d m Y', $p['time']); break;
                                case 'reference':
                                  if (!empty($wo['additional']['reference'])) {
                                    $refUser = Wo_UserData($wo['additional']['reference']);
                                    $value = $refUser['name'] ?? '';
                                  }
                                  break;
                                default:
                                  if (!empty($wo['additional'][$name])) $value = htmlspecialchars($wo['additional'][$name]);
                              }
                          ?>
                            <span class="<?= htmlspecialchars($name, ENT_QUOTES) ?>"
                                  style="position:absolute;top:<?= htmlspecialchars($top, ENT_QUOTES) ?>;left:<?= htmlspecialchars($left, ENT_QUOTES) ?>;width:<?= htmlspecialchars($width, ENT_QUOTES) ?>;font-size:<?= htmlspecialchars($fontSize, ENT_QUOTES) ?>;text-align:<?= htmlspecialchars($textAlign, ENT_QUOTES) ?>;letter-spacing:<?= htmlspecialchars($letterSpacing, ENT_QUOTES) ?>;white-space:normal;line-height:1.4;">
                              <?= htmlspecialchars($value) ?>
                            </span>
                          <?php endforeach; ?>
                        </div>
                      </div>
                    </section>

                    <!-- Purchase Row -->
                    <tr id="purchaseRow_<?= (int)$p['id'] ?>">
                      <td><?= $proj_html ?></td>
                      <td><?= ($booking['project'] == 'hill-town') ? htmlspecialchars(ucwords($booking['block'])) : 'N/A' ?></td>
                      <td><?= htmlspecialchars($booking['katha']) ?></td>
                      <td><?= htmlspecialchars($booking['plot']) ?></td>
                      <td><?= htmlspecialchars($booking['road']) ?></td>
                      <td><?= htmlspecialchars($booking['file_num']) ?></td>
                      <td><?= htmlspecialchars(date('d M Y', $p['time'])) ?></td>
                      <td>
                        <?php
                          $sr = (string)($booking['status'] ?? '');
                          if ($sr === '1') echo '<span class="badge bg-info"> Available </span>';
                          elseif ($sr === '2') echo '<span class="badge bg-success"> Sold </span>';
                          elseif ($sr === '3') echo '<span class="badge bg-success"> Complete </span>';
                          elseif ($sr === '4') echo '<span class="badge bg-danger"> Canceled </span>';
                          else echo '<span class="badge bg-info"> Available </span>';
                        ?>
                      </td>
                      <td class="text-center">
                        <!-- Enhanced Dropdown Actions -->
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                  id="dropdownMenuButton<?= (int)$p['id'] ?>" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="lni lni-more-alt"></i> More
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="dropdownMenuButton<?= (int)$p['id'] ?>">
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-cog me-1"></i> Purchase Actions</h6>
                            </li>
                            <li>
                              <a class="dropdown-item print-booking-form" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-printer me-2 text-primary"></i> Print Booking Form
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item update_installment" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-dollar me-2 text-success"></i> Payment Schedule
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item print_payment_schedule" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-file-text me-2 text-info"></i> Print Payment Schedule
                              </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-layers me-1"></i> Management</h6>
                            </li>
                            <li>
                              <a class="dropdown-item change_plot_btn" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-shuffle me-2 text-warning"></i> Change Plot
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="transferPurchase(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-users me-2 text-info"></i> Transfer Purchase
                              </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-files me-1"></i> Reports & History</h6>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="viewPurchaseHistory(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-calendar me-2 text-info"></i> Purchase History
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="generatePurchaseReport(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-stats-up me-2 text-primary"></i> Generate Report
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="exportPurchaseData(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-download me-2 text-success"></i> Export Data
                              </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-warning me-1"></i> Critical Actions</h6>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="suspendPurchase(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-pause me-2 text-warning"></i> Suspend Purchase
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item cancel-purchase" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-close me-2 text-danger"></i> Cancel Purchase
                              </a>
                            </li>
                          </ul>
                        </div>
                      </td>
                    </tr>
                    <?php endforeach; ?>
                  </tbody>
                </table>
              </div>

              <!-- Add Purchase Button -->
              <div class="p-3 border-top bg-light">
                <button class="btn btn-success btn-sm" id="addPurchaseBtn">
                  <i class="lni lni-plus me-1"></i> Add Purchase
                </button>
              </div>

              <!-- Add Purchase Form -->
              <div id="addPurchaseForm" class="card mx-3 mb-3 border" style="display:none;">
                <div class="card-body">
                  <div class="row g-2">
                    <!-- Select project -->
                    <div class="col-md-4 d-flex flex-column">
                      <label for="projectSelect" class="form-label fw-medium">Project</label>
                      <select id="projectSelect" class="form-control">
                        <option value="">Select Project</option>
                        <?php foreach ($db->orderBy('id', 'ASC')->get(T_PROJECTS) as $proj): ?>
                          <option value="<?= htmlspecialchars($proj->slug, ENT_QUOTES) ?>"><?= htmlspecialchars($proj->name) ?></option>
                        <?php endforeach; ?>
                      </select>
                    </div>

                    <!-- Select plot -->
                    <div class="col-md-8 d-flex flex-column">
                      <label for="purchaseSelect" class="form-label fw-medium">Plot</label>
                      <select id="purchaseSelect" class="form-control"></select>
                    </div>
                  </div>

                  <!-- Hidden details shown after plot selected -->
                  <div id="purchaseDetails" class="mt-3" style="display:none;">
                    <div class="row g-2">
                      <div class="col-md-2">
                        <label for="detailBlock" class="form-label fw-medium">Block</label>
                        <input type="text" id="detailBlock" class="form-control" readonly tabindex="-1">
                      </div>
                      <div class="col-md-2">
                        <label for="detailPlot" class="form-label fw-medium">Plot</label>
                        <input type="text" id="detailPlot" class="form-control" readonly tabindex="-1">
                      </div>
                      <div class="col-md-3">
                        <label for="detailRoad" class="form-label fw-medium">Road</label>
                        <input type="text" id="detailRoad" class="form-control" readonly tabindex="-1">
                      </div>
                      <div class="col-md-2">
                        <label for="detailStatus" class="form-label fw-medium">Status</label>
                        <input type="text" id="detailStatus" class="form-control" readonly tabindex="-1">
                      </div>
                      <div class="col-md-3">
                        <label for="purchaseDate" class="form-label fw-medium">Booking Date</label>
                        <input type="date" id="purchaseDate" class="form-control" value="<?= date('Y-m-d') ?>">
                      </div>
                      <div class="col-md-2">
                        <label for="detailFacing" class="form-label fw-medium">Facing</label>
                        <input type="text" id="detailFacing" class="form-control" readonly tabindex="-1">
                      </div>
                    </div>

                    <div class="row g-2 mt-2">
                      <div class="col-md-3">
                        <label for="file_num" class="form-label fw-medium">File Number</label>
                        <input type="text" id="file_num" class="form-control" placeholder="File Number" required>
                      </div>
                      <div class="col-md-2">
                        <label for="perKathaPrice" class="form-label fw-medium">Price per Katha</label>
                        <input type="number" id="perKathaPrice" class="form-control" placeholder="৳" required>
                      </div>
                      <div class="col-md-2">
                        <label for="bookingMoney" class="form-label fw-medium">Booking Money (৳)</label>
                        <input type="number" id="bookingMoney" class="form-control" placeholder="৳" value="0" required>
                      </div>
                      <div class="col-md-2">
                        <label for="downPayment" class="form-label fw-medium">Down Payment</label>
                        <input type="number" id="downPayment" class="form-control" placeholder="৳" required>
                      </div>
                      <div class="col-md-1">
                        <label for="totalPrice" class="form-label fw-medium">Total Price</label>
                        <input type="text" id="totalPrice" class="form-control" readonly tabindex="-1">
                      </div>
                      <div class="col-md-2">
                        <label for="duePrice" class="form-label fw-medium">Due After Advance</label>
                        <input type="text" id="duePrice" class="form-control" readonly tabindex="-1">
                      </div>
                    </div>

                    <!-- Nominees multi-select -->
                    <div class="row g-2 mt-2">
                      <div class="col-md-12 d-flex flex-column">
                        <label for="nomineeSelect" class="form-label fw-medium">Nominees</label>
                        <select id="nomineeSelect" name="nominee_ids[]" class="form-select" multiple="multiple" data-placeholder="Select nominee(s)">
                          <?php if (!empty($get_nominees) && is_array($get_nominees)): foreach ($get_nominees as $nom): ?>
                            <option value="<?= (int)$nom->id ?>"><?= htmlspecialchars($nom->name . (!empty($nom->relation) ? ' — ' . $nom->relation : '')) ?></option>
                          <?php endforeach; endif; ?>
                        </select>
                        <small class="form-text text-muted">Choose one or more nominees for this purchase (optional).</small>
                      </div>
                    </div>
                  </div>

                  <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary" id="savePurchaseBtn">Save</button>
                    <button class="btn btn-secondary" id="cancelPurchaseBtn">Cancel</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Client Details Card -->
          <div class="card mt-4 border-0 shadow-sm">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="mb-0 fw-semibold text-dark">Client Information</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="d-flex align-items-center mb-3">
                    <ion-icon name="person-circle" class="text-primary fs-5 me-2"></ion-icon>
                    <div>
                      <small class="text-muted">Name</small>
                      <div class="fw-medium"><?= htmlspecialchars($wo['client']['name']) ?></div>
                    </div>
                  </div>
                  
                  <div class="d-flex align-items-center mb-3">
                    <ion-icon name="location" class="text-primary fs-5 me-2"></ion-icon>
                    <div>
                      <small class="text-muted">Address</small>
                      <div class="fw-medium"><?= htmlspecialchars($wo['client']['address']) ?></div>
                    </div>
                  </div>
                  
                  <div class="d-flex align-items-center mb-3">
                    <ion-icon name="call" class="text-primary fs-5 me-2"></ion-icon>
                    <div>
                      <small class="text-muted">Phone</small>
                      <div class="fw-medium"><?= htmlspecialchars($wo['client']['phone']) ?></div>
                    </div>
                  </div>

                  <?php if (!empty($wo['additional']['reference'])): ?>
                    <div class="d-flex align-items-center mb-3">
                      <ion-icon name="link" class="text-primary fs-5 me-2"></ion-icon>
                      <div>
                        <small class="text-muted">Reference</small>
                        <div class="fw-medium"><?= htmlspecialchars(Wo_UserData($wo['additional']['reference'])['name']) ?></div>
                      </div>
                    </div>
                  <?php endif; ?>
                </div>

                <div class="col-md-6">
                  <?php if ($wo['additional']): ?>
                    <h6 class="fw-semibold mb-3">Additional Details</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-borderless mb-0">
                        <tbody>
                          <?php foreach ([
                            'spouse_name'=>'Spouse Name','fathers_name'=>'Father\'s Name','permanent_addr'=>'Permanent Address',
                            'email'=>'Email','nationality'=>'Nationality','birthday'=>'Birthday','religion'=>'Religion',
                            'nid'=>'National ID','passport'=>'Passport'
                          ] as $key=>$label): if (!empty($wo['additional'][$key])):
                            $val = htmlspecialchars($wo['additional'][$key]);
                          ?>
                            <tr>
                              <td class="text-muted small" style="width:40%"><?= $label ?></td>
                              <td class="fw-medium"><?= $val ?></td>
                            </tr>
                          <?php endif; endforeach; ?>
                        </tbody>
                      </table>
                    </div>
                  <?php endif; ?>
                </div>
              </div>

              <div class="mt-4 pt-3 border-top">
                <button class="btn btn-outline-primary show-booking-form">
                  <i class="lni lni-print me-1"></i> Print Booking Form
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
      
<!-- Cancel Purchase Modal -->
<div class="modal fade" id="cancelPurchaseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0 bg-danger text-white">
          <h5 class="modal-title mb-0">Cancel Purchase</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body py-4">
          <p class="text-muted mb-3">Select cancellation date for this purchase</p>
          <input type="date" id="cancel_purchase_date" class="form-control" value="<?= date('Y-m-d') ?>">
          <input type="hidden" id="cancel_purchase_id" value="">
          <div id="cancelPurchaseError" class="text-danger small mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer border-0 bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmCancelPurchaseBtn" class="btn btn-danger">Confirm Cancellation</button>
        </div>
      </div>
    </div>
</div>

<!-- Transfer Purchase Modal -->
<div class="modal fade" id="transferPurchaseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-info text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-users me-2"></i>Transfer Purchase
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body py-4">
        <input type="hidden" id="transfer_purchase_id" value="">
        
        <div class="mb-3">
          <label class="form-label fw-medium">Select Target Client</label>
          <select id="transfer_client_select" class="form-control">
            <option value="">Choose client to transfer to...</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-medium">Transfer Date</label>
          <input type="date" id="transfer_date" class="form-control" value="<?= date('Y-m-d') ?>">
        </div>

        <div class="mb-3">
          <label class="form-label fw-medium">Transfer Reason</label>
          <textarea id="transfer_reason" class="form-control" rows="3" placeholder="Enter reason for transfer..."></textarea>
        </div>

        <div class="alert alert-warning">
          <strong>Note:</strong> This will transfer the purchase to the selected client. The action cannot be undone.
        </div>

        <div class="alert alert-danger d-none" id="transfer_error" role="alert"></div>
      </div>

      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="transfer_purchase_save" class="btn btn-info text-white">
          <i class="lni lni-users me-1"></i>Transfer Purchase
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Suspend Purchase Modal -->
<div class="modal fade" id="suspendPurchaseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-warning text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-pause me-2"></i>Suspend Purchase
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body py-4">
        <input type="hidden" id="suspend_purchase_id" value="">
        
        <div class="mb-3">
          <label class="form-label fw-medium">Suspension Date</label>
          <input type="date" id="suspend_date" class="form-control" value="<?= date('Y-m-d') ?>">
        </div>

        <div class="mb-3">
          <label class="form-label fw-medium">Suspension Duration</label>
          <select id="suspend_duration" class="form-control">
            <option value="30">30 Days</option>
            <option value="60">60 Days</option>
            <option value="90">90 Days</option>
            <option value="180">6 Months</option>
            <option value="365">1 Year</option>
            <option value="custom">Custom Duration</option>
          </select>
        </div>

        <div class="mb-3 d-none" id="custom_duration_field">
          <label class="form-label fw-medium">Custom Duration (Days)</label>
          <input type="number" id="custom_duration_days" class="form-control" min="1" placeholder="Enter number of days">
        </div>

        <div class="mb-3">
          <label class="form-label fw-medium">Suspension Reason</label>
          <textarea id="suspend_reason" class="form-control" rows="3" placeholder="Enter reason for suspension..." required></textarea>
        </div>

        <div class="alert alert-warning">
          <strong>Note:</strong> Suspended purchases will be temporarily inactive and won't appear in regular reports.
        </div>

        <div class="alert alert-danger d-none" id="suspend_error" role="alert"></div>
      </div>

      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="suspend_purchase_save" class="btn btn-warning text-white">
          <i class="lni lni-pause me-1"></i>Suspend Purchase
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Purchase History Modal -->
<div class="modal fade" id="purchaseHistoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-info text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-calendar me-2"></i>Purchase History
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="history_purchase_id" value="">
        
        <div id="history_content">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading purchase history...</p>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="export_history" class="btn btn-info text-white">
          <i class="lni lni-download me-1"></i>Export History
        </button>
      </div>
    </div>
  </div>
</div>

    </div>
  </div>
</div>

<!-- Enhanced Update Installment Modal -->
<div class="modal fade" id="updateInstallmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-success text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-dollar me-2"></i>Payment Schedule — <span id="ui_project_name"></span>
        </h5>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-light btn-sm" id="print_schedule_btn" title="Print Schedule">
            <i class="lni lni-printer"></i>
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" id="export_schedule_xlsx" title="Export XLSX">
            <i class="lni lni-download"></i>
          </button>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>

      <div class="modal-body p-4">
        <input type="hidden" id="ui_purchase_id" value="">

        <!-- Summary Section -->
        <div class="row g-3 mb-4">
          <div class="col-md-2">
            <div class="card bg-primary text-white h-100">
              <div class="card-body p-3 text-center">
                <small class="opacity-75">Total Price</small>
                <div class="h6 mb-0">৳<span id="ui_total_price">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card bg-info text-white h-100">
              <div class="card-body p-3 text-center">
                <small class="opacity-75">Booking Money</small>
                <div class="h6 mb-0">৳<span id="ui_booking_money">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card bg-warning text-white h-100">
              <div class="card-body p-3 text-center">
                <small class="opacity-75">Down Payment</small>
                <div class="h6 mb-0">৳<span id="ui_down_payment">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card bg-secondary text-white h-100">
              <div class="card-body p-3 text-center">
                <small class="opacity-75">Remaining</small>
                <div class="h6 mb-0">৳<span id="ui_remaining">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card bg-dark text-white h-100">
              <div class="card-body p-3 text-center">
                <small class="opacity-75">Schedule Total</small>
                <div class="h6 mb-0">৳<span id="ui_schedule_total">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card bg-success text-white h-100">
              <div class="card-body p-3 text-center">
                <small class="opacity-75">Paid Amount</small>
                <div class="h6 mb-0">৳<span id="ui_paid_amount">0</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule Status Toggle -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="d-flex align-items-center gap-3">
              <label class="form-label mb-0 fw-medium">Schedule Status:</label>
              <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="schedule_status" id="schedule_paid" value="paid">
                <label class="btn btn-outline-success btn-sm" for="schedule_paid">
                  <i class="lni lni-checkmark me-1"></i>Paid
                </label>
                <input type="radio" class="btn-check" name="schedule_status" id="schedule_unpaid" value="unpaid" checked>
                <label class="btn btn-outline-warning btn-sm" for="schedule_unpaid">
                  <i class="lni lni-time me-1"></i>Unpaid
                </label>
              </div>
            </div>
          </div>
          <div class="col-md-6 text-end">
            <button class="btn btn-outline-secondary btn-sm" id="ui_change_schedule" style="display:none;">
              <i class="lni lni-edit me-1"></i>Change Schedule
            </button>
          </div>
        </div>

        <!-- Payment Configuration Section -->
        <div id="ui_configuration_section" class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-light border-0">
            <h6 class="mb-0 fw-semibold">Payment Configuration</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label fw-medium">Mode of Payment</label>
                <select id="ui_mode" class="form-control">
                  <option value="1">Full Payment</option>
                  <option value="2">Installment</option>
                </select>
              </div>

              <!-- installment-specific controls -->
              <div id="ui_installment_controls" class="col-md-9 d-none">
                <div class="row g-3">
                  <div class="col-md-2">
                    <label class="form-label fw-medium">Installments</label>
                    <input type="number" id="ui_installments" class="form-control" min="1" value="12" step="1">
                  </div>

                  <div class="col-md-3">
                    <label class="form-label fw-medium">Adjustment Type</label>
                    <select id="ui_adjustment_type" class="form-control">
                      <option value="monthly">Monthly (even split)</option>
                      <option value="year_start">Year — Start</option>
                      <option value="year_middle">Year — Middle</option>
                      <option value="year_end" selected>Year — End</option>
                      <option value="custom">Custom (no yearly auto)</option>
                    </select>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label fw-medium">Monthly Amount <small class="text-muted">(optional)</small></label>
                    <input type="number" id="ui_monthly_amount" class="form-control" placeholder="Auto-calc if empty">
                    <small class="text-muted">If empty, auto-calculated based on remaining amount after yearly adjustments.</small>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label fw-medium">Yearly Adjustment <small class="text-muted">(optional)</small></label>
                    <input type="number" id="ui_yearly_adjustment" class="form-control" placeholder="e.g. 100000">
                    <small class="text-muted">Fixed amount added once per year (not added to monthly).</small>
                  </div>
                </div>
              </div>

              <div class="col-md-12">
                <div class="row g-2">
                  <div class="col-md-4">
                    <label class="form-label fw-medium">Start Date</label>
                    <input type="date" id="ui_start_date" class="form-control">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-medium">Start Option</label>
                    <select id="ui_start_option" class="form-control">
                      <option value="start">Start of month (1st)</option>
                      <option value="middle">Middle (15th)</option>
                      <option value="end">End of month (last day)</option>
                      <option value="exact">Exact (keep chosen day)</option>
                    </select>
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <div class="btn-group w-100" role="group">
                      <button class="btn btn-primary" id="ui_generate_schedule">
                        <i class="lni lni-plus me-1"></i>Generate Schedule
                      </button>
                      <button class="btn btn-outline-secondary" id="ui_reset_schedule">
                        <i class="lni lni-refresh me-1"></i>Reset
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Schedule Table -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold">Payment Schedule</h6>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-success" id="ui_mark_all_paid">
                <i class="lni lni-checkmark me-1"></i>Mark All Paid
              </button>
              <button type="button" class="btn btn-outline-warning" id="ui_mark_all_unpaid">
                <i class="lni lni-time me-1"></i>Mark All Unpaid
              </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive" style="max-height:420px;overflow:auto;">
              <table class="table table-hover mb-0" id="ui_schedule_table">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:45px">#</th>
                    <th style="width:160px">Date</th>
                    <th>Amount (৳)</th>
                    <th style="width:140px">Adjustment <small>(manual)</small></th>
                    <th style="width:120px">Payment Status</th>
                    <th style="width:90px">Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot class="table-light">
                  <tr class="fw-semibold">
                    <td colspan="1">Total</td>
                    <td id="ui_total_date">-</td>
                    <td>৳<span id="ui_total_amount">0</span></td>
                    <td colspan="3"></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 bg-light d-flex justify-content-between">
        <div class="text-muted small">
          <strong>Note:</strong> All amounts are in Bangladeshi Taka (৳)
        </div>
        <div class="btn-group" role="group">
          <button id="ui_save_schedule" class="btn btn-success">
            <i class="lni lni-save me-1"></i>Save Schedule
          </button>
          <button id="ui_close" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="lni lni-close me-1"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Change Plot Modal -->
<div class="modal fade" id="changePlotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-warning text-white border-0">
        <h5 class="modal-title mb-0">
          <i class="lni lni-exchange me-2"></i>Change Booked Plot
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body py-4">
        <input type="hidden" id="change_plot_purchase_id" value="">
        
        <div class="mb-3">
          <label class="form-label fw-medium">Current Project</label>
          <input type="text" id="change_plot_project" class="form-control" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label fw-medium">Available Plots</label>
          <select id="change_plot_select" class="form-control">
            <option value="">Select available plot</option>
          </select>
        </div>

        <div class="alert alert-danger d-none" id="change_plot_error" role="alert"></div>
      </div>

      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="change_plot_save" class="btn btn-warning text-white">
          <i class="lni lni-exchange me-1"></i>Change Plot
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Print Schedule Modal -->
<div id="printScheduleContent" class="d-none">
  <div class="schedule-print-template">
    <div class="print-header text-center mb-4">
      <h2 class="company-name mb-2" id="print_company_name"></h2>
      <h4 class="document-title">Payment Schedule</h4>
      <hr>
    </div>
    
    <div class="client-info row mb-4">
      <div class="col-6">
        <h5>Client Information</h5>
        <table class="table table-borderless table-sm">
          <tr><td class="fw-bold">Name:</td><td id="print_client_name">-</td></tr>
          <tr><td class="fw-bold">Phone:</td><td id="print_client_phone">-</td></tr>
          <tr><td class="fw-bold">Address:</td><td id="print_client_address">-</td></tr>
        </table>
      </div>
      <div class="col-6">
        <h5>Project Information</h5>
        <table class="table table-borderless table-sm">
          <tr><td class="fw-bold">Project:</td><td id="print_project_name">-</td></tr>
          <tr><td class="fw-bold">Plot:</td><td id="print_plot_info">-</td></tr>
          <tr><td class="fw-bold">File Number:</td><td id="print_file_number">-</td></tr>
        </table>
      </div>
    </div>

    <div class="purchase-info mb-4">
      <h5>Purchase Details</h5>
      <div class="row">
        <div class="col-3">
          <div class="card text-center">
            <div class="card-body p-2">
              <small>Total Price</small>
              <div class="fw-bold">৳<span id="print_total_price">0</span></div>
            </div>
          </div>
        </div>
        <div class="col-3">
          <div class="card text-center">
            <div class="card-body p-2">
              <small>Booking Money</small>
              <div class="fw-bold">৳<span id="print_booking_money">0</span></div>
            </div>
          </div>
        </div>
        <div class="col-3">
          <div class="card text-center">
            <div class="card-body p-2">
              <small>Down Payment</small>
              <div class="fw-bold">৳<span id="print_down_payment">0</span></div>
            </div>
          </div>
        </div>
        <div class="col-3">
          <div class="card text-center">
            <div class="card-body p-2">
              <small>Remaining</small>
              <div class="fw-bold">৳<span id="print_remaining">0</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="schedule-table">
      <h5>Payment Schedule</h5>
      <table class="table table-bordered table-sm">
        <thead class="table-light">
          <tr>
            <th width="5%">#</th>
            <th width="15%">Due Date</th>
            <th width="15%">Amount (৳)</th>
            <th width="10%">Status</th>
            <th width="55%">Notes</th>
          </tr>
        </thead>
        <tbody id="print_schedule_rows">
        </tbody>
        <tfoot class="table-light">
          <tr class="fw-bold">
            <td colspan="2">Total</td>
            <td>৳<span id="print_schedule_total">0</span></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="print-footer mt-4">
      <div class="row">
        <div class="col-6">
          <p><strong>Generated on:</strong> <span id="print_date"></span></p>
          <p><strong>Generated by:</strong> <?= htmlspecialchars($wo['user']['name'] ?? 'System') ?></p>
        </div>
        <div class="col-6 text-end">
          <div class="signature-area">
            <p class="mb-4">_________________________</p>
            <p>Authorized Signature</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<?= Wo_LoadManagePage('clients/style') ?>
<?= Wo_LoadManagePage('clients/main_script') ?>