<?php
Global $client, $booking_helper, $invoice, $additional;

// Get nominees for this client
$nominees = get_nominees_by_customer_id($client['id']);

// Get project mapping for background images
$project_mapping = [
    'moon-hill' => 1,
    'hill-town' => 6,
];

// Calculate totals
$total_amount = 0;
$total_paid = 0;
$total_due = 0;

if (!empty($invoice)) {
    foreach ($invoice as $inv) {
        $total_amount += $inv['total_amount'];
        $total_paid += $inv['pay_amount'];
    }
    $total_due = $total_amount - $total_paid;
}
?>

<!-- Main View Client Modal -->
<div class="modal fade full_screen" id="viewClient-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-lg-down">
    <div class="modal-content" style="border-radius:12px;overflow:hidden;">

      <!-- Header -->
      <div class="modal-header bg-white border-0 py-3 px-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          <div style="width:56px;height:56px;background:#f6f8fb;border-radius:10px;display:flex;align-items:center;justify-content:center;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zM4 20c0-3.314 2.686-6 6-6h4c3.314 0 6 2.686 6 6v1H4v-1z" fill="#6c757d"/>
            </svg>
          </div>
          <div>
            <div class="small text-muted">Client Profile</div>
            <div class="fw-semibold" style="font-size:16px;line-height:1;"><?php echo htmlspecialchars($client['name']); ?></div>
            <div class="small text-muted">ID: <?php echo htmlspecialchars($client['id']); ?> â€¢ Phone: <?php echo htmlspecialchars($client['phone']); ?></div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPurchaseModal()">New Purchase</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openInstallmentModal()">Installments</button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>

      <!-- Body -->
      <div class="modal-body p-4" style="background:#fbfdff;">
        <div class="row gx-4 gy-3">
          
          <!-- Left Column: Client Info & Purchase History -->
          <div class="col-12 col-lg-8">
            <?php echo Wo_LoadManagePage('clients/includes/client_info'); ?>
            <?php echo Wo_LoadManagePage('clients/includes/purchase_history'); ?>
          </div>

          <!-- Right Column: Financial Summary -->
          <div class="col-12 col-lg-4">
            <?php echo Wo_LoadManagePage('clients/includes/financial_summary'); ?>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- Include Modal Components -->
<?php echo Wo_LoadManagePage('clients/modals/purchase_modal'); ?>
<?php echo Wo_LoadManagePage('clients/modals/installment_modal'); ?>
<?php echo Wo_LoadManagePage('clients/modals/cancel_modal'); ?>

<!-- Include JavaScript -->
<script>
<?php echo file_get_contents('manage/pages/clients/js/view_client.js'); ?>
</script>