<div class="self_remove_on_close">
  <!-- code will be self remove on modal close also remove the binded functions and events from window to prevent the conflict/problem when the same modal load again using fetch/xhr -->
<?php
/* view_client.phtml
   Complete client view with enhanced payment schedule functionality and all dropdown actions
*/
Global $project_mapping;
global $db, $wo;

// Fetch users
$get_users = $db->orderBy('position', 'ASC')->where('active', '1')->where('banned', '0')->get(T_USERS);

// Totals - Fixed calculations
$clientId = $wo['client']['id'];

// Fixed total amount calculation - sum of (per_katha * katha) from booking_helper with proper joins
$total_amount = 0;
$total_purchase = 0;
try {
    $helpers = $db->rawQuery("
        SELECT bh.per_katha, b.katha 
        FROM `" . T_BOOKING_HELPER . "` bh
        JOIN `" . T_BOOKING . "` b ON b.id = bh.booking_id
        WHERE bh.client_id = ? AND bh.status != '4'
    ", [$clientId]);
    
    foreach ($helpers as $helper) {
        $per_katha = (float)($helper->per_katha ?? 0);
        $katha = (float)($helper->katha ?? 0);
        $total_amount += ($per_katha * $katha);
        $total_purchase++;
    }
} catch (Exception $e) {
    $total_amount = 0;
    $total_purchase = 0;
}

$total_paid    = (float) $db->where('customer_id', $clientId)->getValue(T_INVOICE, 'SUM(pay_amount)') ?: 0;
$total_due     = $total_amount - $total_paid;
$total_invoice = (int)   $db->where('customer_id', $clientId)->getValue(T_INVOICE, 'COUNT(*)');

//crm_nominees -> T_CRM_NOMINEES
$get_nominees = $db->where('customer_id', $clientId)->orderBy('name', 'ASC')->get(T_CRM_NOMINEES);
?>

<div class="modal fade full_screen" id="viewClient-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content border-0 shadow-lg">

      <!-- Header with modern styling -->
      <div class="modal-header no-print bg-gradient-primary text-white border-0">
        <div class="d-flex align-items-center gap-3">
          <div class="avatar rounded-circle bg-white text-primary d-flex align-items-center justify-content-center" style="width:48px;height:48px;font-weight:700;font-size:18px;">
            <?= strtoupper(substr($wo['client']['name'],0,1)) ?>
          </div>
          <div>
            <h4 class="mb-0 text-white"><?= htmlspecialchars($wo['client']['name']) ?></h4>
            <div class="text-white-50 small"><?= htmlspecialchars($wo['client']['email'] ?? '') ?></div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button id="printButton" class="btn btn-outline-light btn-sm" title="Print booking form">
            <i class="lni lni-printer me-1"></i> Print
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal" aria-label="Close">
            <i class="lni lni-close"></i>
          </button>
        </div>
      </div>

      <div class="view-container form-toggle">
        <!-- Summary Cards with modern design -->
        <section id="client_details" class="no-print mt-4 px-4">
          <div class="row g-3 mb-4">
            <?php foreach ([['Plots', number_format($total_purchase), 'cart', 'info'], ['Total', "৳".number_format($total_amount), 'bag-handle-sharp', 'primary'], ['Paid', "৳".number_format($total_paid), 'checkmark-circle', 'success'], ['Due', "৳".number_format($total_due), 'time', 'danger']] as [$title, $value, $icon, $variant]): ?>
              <div class="col-6 col-md-4 col-lg">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="card-body d-flex align-items-center p-3">
                    <div class="flex-grow-1">
                      <p class="text-muted mb-1 small fw-medium"><?= htmlspecialchars($title) ?></p>
                      <h5 class="mb-0 fw-bold"><?= htmlspecialchars($value) ?></h5>
                    </div>
                    <div class="fs-2 text-<?= $variant ?>">
                      <ion-icon name="<?= htmlspecialchars($icon) ?>"></ion-icon>
                    </div>
                  </div>
                </div>
              </div>
            <?php endforeach; ?>
          </div>

          <!-- Purchase Table with modern styling -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="mb-0 fw-semibold text-dark">Purchase Details</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="purchaseTable">
                  <thead class="table-light">
                    <tr>
                      <th class="fw-semibold">Project</th>
                      <th class="fw-semibold">Block</th>
                      <th class="fw-semibold">Katha</th>
                      <th class="fw-semibold">Plot</th>
                      <th class="fw-semibold">Road</th>
                      <th class="fw-semibold">File</th>
                      <th class="fw-semibold">Date</th>
                      <th class="fw-semibold">Status</th>
                      <th class="fw-semibold text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php
                    foreach ($wo['booking_helper'] as $index => $p):
                      $client = $p['client'];
                      $booking = $p['booking'];

                      $proj_raw = isset($booking['project']) ? $booking['project'] : '';
                      $proj_raw = str_replace('-', ' ', $proj_raw);
                      $proj_raw = ucwords($proj_raw);
                      $proj_html = htmlspecialchars($proj_raw, ENT_QUOTES);
                      if ($proj_html === '') $proj_html = '-';
                    ?>

                    <?= Wo_LoadManagePage('clients/booking_form_template', ['p' => $p, 'index' => $index, 'client' => $client, 'booking' => $booking, 'proj_html' => $proj_html]) ?>

                    <!-- Purchase Row -->
                    <tr id="purchaseRow_<?= (int)$p['id'] ?>">
                      <td><?= $proj_html ?></td>
                      <td><?= ($booking['project'] == 'hill-town') ? htmlspecialchars(ucwords($booking['block'])) : 'N/A' ?></td>
                      <td><?= htmlspecialchars($booking['katha']) ?></td>
                      <td><?= htmlspecialchars($booking['plot']) ?></td>
                      <td><?= htmlspecialchars($booking['road']) ?></td>
                      <td><?= htmlspecialchars($booking['file_num']) ?></td>
                      <td><?= htmlspecialchars(date('d M Y', $p['time'])) ?></td>
                      <td>
                        <?php
                          $sr = (string)($booking['status'] ?? '');
                          if ($sr === '1') echo '<span class="badge bg-info"> Available </span>';
                          elseif ($sr === '2') echo '<span class="badge bg-success"> Sold </span>';
                          elseif ($sr === '3') echo '<span class="badge bg-success"> Complete </span>';
                          elseif ($sr === '4') echo '<span class="badge bg-danger"> Canceled </span>';
                          else echo '<span class="badge bg-info"> Available </span>';
                        ?>
                      </td>
                      <td class="text-center">
                        <!-- Enhanced Dropdown Actions -->
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                  id="dropdownMenuButton<?= (int)$p['id'] ?>" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="lni lni-more-alt"></i> More
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="dropdownMenuButton<?= (int)$p['id'] ?>">
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-cog me-1"></i> Purchase Actions</h6>
                            </li>
                            <li>
                              <a class="dropdown-item print-booking-form" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-printer me-2 text-primary"></i> Print Booking Form
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item update_installment" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-dollar me-2 text-success"></i> Payment Schedule
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item print_payment_schedule" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-file-text me-2 text-info"></i> Print Payment Schedule
                              </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-layers me-1"></i> Management</h6>
                            </li>
                            <li>
                              <a class="dropdown-item change_plot_btn" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-shuffle me-2 text-warning"></i> Change Plot
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="transferPurchase(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-users me-2 text-info"></i> Transfer Purchase
                              </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-files me-1"></i> Reports & History</h6>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="viewPurchaseHistory(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-calendar me-2 text-info"></i> Purchase History
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="generatePurchaseReport(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-stats-up me-2 text-primary"></i> Generate Report
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="exportPurchaseData(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-download me-2 text-success"></i> Export Data
                              </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <h6 class="dropdown-header"><i class="lni lni-warning me-1"></i> Critical Actions</h6>
                            </li>
                            <li>
                              <a class="dropdown-item" href="javascript:;" onclick="suspendPurchase(<?= (int)$p['id'] ?>)">
                                <i class="lni lni-pause me-2 text-warning"></i> Suspend Purchase
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item cancel-purchase" href="javascript:;" data-id="<?= (int)$p['id'] ?>">
                                <i class="lni lni-close me-2 text-danger"></i> Cancel Purchase
                              </a>
                            </li>
                          </ul>
                        </div>
                      </td>
                    </tr>
                    <?php endforeach; ?>
                  </tbody>
                </table>
              </div>

              <?= Wo_LoadManagePage('clients/add_purchase_form', ['get_nominees' => $get_nominees]) ?>

            </div>
          </div>

          <!-- Client Details Card -->
          <div class="card mt-4 border-0 shadow-sm">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="mb-0 fw-semibold text-dark">Client Information</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="d-flex align-items-center mb-3">
                    <ion-icon name="person-circle" class="text-primary fs-5 me-2"></ion-icon>
                    <div>
                      <small class="text-muted">Name</small>
                      <div class="fw-medium"><?= htmlspecialchars($wo['client']['name']) ?></div>
                    </div>
                  </div>
                  
                  <div class="d-flex align-items-center mb-3">
                    <ion-icon name="location" class="text-primary fs-5 me-2"></ion-icon>
                    <div>
                      <small class="text-muted">Address</small>
                      <div class="fw-medium"><?= htmlspecialchars($wo['client']['address']) ?></div>
                    </div>
                  </div>
                  
                  <div class="d-flex align-items-center mb-3">
                    <ion-icon name="call" class="text-primary fs-5 me-2"></ion-icon>
                    <div>
                      <small class="text-muted">Phone</small>
                      <div class="fw-medium"><?= htmlspecialchars($wo['client']['phone']) ?></div>
                    </div>
                  </div>

                  <?php if (!empty($wo['additional']['reference'])): ?>
                    <div class="d-flex align-items-center mb-3">
                      <ion-icon name="link" class="text-primary fs-5 me-2"></ion-icon>
                      <div>
                        <small class="text-muted">Reference</small>
                        <div class="fw-medium"><?= htmlspecialchars(Wo_UserData($wo['additional']['reference'])['name']) ?></div>
                      </div>
                    </div>
                  <?php endif; ?>
                </div>

                <div class="col-md-6">
                  <?php if ($wo['additional']): ?>
                    <h6 class="fw-semibold mb-3">Additional Details</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-borderless mb-0">
                        <tbody>
                          <?php foreach ([
                            'spouse_name'=>'Spouse Name','fathers_name'=>'Father\'s Name','permanent_addr'=>'Permanent Address',
                            'email'=>'Email','nationality'=>'Nationality','birthday'=>'Birthday','religion'=>'Religion',
                            'nid'=>'National ID','passport'=>'Passport'
                          ] as $key=>$label): if (!empty($wo['additional'][$key])):
                            $val = htmlspecialchars($wo['additional'][$key]);
                          ?>
                            <tr>
                              <td class="text-muted small" style="width:40%"><?= $label ?></td>
                              <td class="fw-medium"><?= $val ?></td>
                            </tr>
                          <?php endif; endforeach; ?>
                        </tbody>
                      </table>
                    </div>
                  <?php endif; ?>
                </div>
              </div>

              <div class="mt-4 pt-3 border-top">
                <button class="btn btn-outline-primary show-booking-form">
                  <i class="lni lni-print me-1"></i> Print Booking Form
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
      
      <!-- Load all modals -->
      <?= Wo_LoadManagePage('clients/cancel_purchase_modal') ?>
      <?= Wo_LoadManagePage('clients/transfer_purchase_modal') ?>
      <?= Wo_LoadManagePage('clients/suspend_purchase_modal') ?>
      <?= Wo_LoadManagePage('clients/purchase_history_modal') ?>
      <?= Wo_LoadManagePage('clients/update_installment_modal') ?>
      <?= Wo_LoadManagePage('clients/change_plot_modal') ?>
      <?= Wo_LoadManagePage('clients/print_schedule_template') ?>

    </div>
  </div>
</div>

<!-- Core JavaScript for View Client -->
<script>
jQuery(function($){
  'use strict';

  // Core utilities
  function moneyVal(v){
    if (v === undefined || v === null) return 0;
    var s = String(v).replace(/,/g,'').trim();
    if (s === '') return 0;
    var n = Number(s);
    return isNaN(n) ? 0 : n;
  }

  function fmtMoney(v){
    if (v === undefined || v === null) v = 0;
    return Number(Math.round(v * 100) / 100).toLocaleString('en-US', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 1
    });
  }

  // Initialize modal components when modal opens
  $('#viewClient-modal').on('shown.bs.modal', function(){
    // Initialize all components
    if (typeof initViewClientComponents === 'function') {
      initViewClientComponents();
    }
  });

  // Cleanup when modal closes - self remove all bindings
  $('#viewClient-modal').on('hidden.bs.modal', function(){
    // Destroy all Select2 instances
    $('#viewClient-modal').find('.select2-hidden-accessible').each(function(){
      try {
        $(this).select2('destroy');
      } catch(e) {}
    });
    
    // Remove all event handlers bound to window
    $(window).off('.viewClient');
    $(document).off('.viewClient');
    
    // Clear any intervals or timeouts
    if (window.viewClientIntervals) {
      window.viewClientIntervals.forEach(function(id) {
        clearInterval(id);
      });
      window.viewClientIntervals = [];
    }
    
    if (window.viewClientTimeouts) {
      window.viewClientTimeouts.forEach(function(id) {
        clearTimeout(id);
      });
      window.viewClientTimeouts = [];
    }
    
    // Clean up global functions
    delete window.transferPurchase;
    delete window.viewPurchaseHistory;
    delete window.generatePurchaseReport;
    delete window.exportPurchaseData;
    delete window.suspendPurchase;
    delete window.initViewClientComponents;
  });

  // Wire #printButton to print ALL booking forms in this modal
  $('#printButton').off('click').on('click', function(){
    var ids = [];
    $('#viewClient-modal .print_area').each(function(){
      var id = $(this).attr('data-purchase-id');
      if (id) ids.push(id);
    });
    if (!ids.length) {
      alert('No booking forms available to print.');
      return;
    }
    printBookingFormsByIds(ids);
  });

  // Enhanced printing helpers with image preloading
  function preloadBackgroundImages(nodes, callback) {
    var imageUrls = [];
    var loadedCount = 0;
    
    // Extract background image URLs from nodes
    nodes.forEach(function(node){
      var $node = $(node);
      var bgImage = $node.css('background-image');
      if (bgImage && bgImage !== 'none') {
        var match = bgImage.match(/url\(['"]?(.*?)['"]?\)/);
        if (match && match[1]) {
          imageUrls.push(match[1]);
        }
      }
    });

    // If no images to load, callback immediately
    if (imageUrls.length === 0) {
      callback();
      return;
    }

    // Preload each image
    imageUrls.forEach(function(url) {
      var img = new Image();
      img.onload = img.onerror = function() {
        loadedCount++;
        if (loadedCount >= imageUrls.length) {
          callback();
        }
      };
      img.src = url;
    });

    // Fallback timeout in case images don't load
    setTimeout(function() {
      if (loadedCount < imageUrls.length) {
        console.warn('Some background images did not load in time');
        callback();
      }
    }, 5000); // 5 second timeout
  }

  function _createPrintWrapperForNodes(nodes) {
    var $wrap = $('<div id="print-wrapper-temp"></div>');
    $wrap.css({ position: 'relative', zIndex: 99999 });
    nodes.forEach(function(node){
      var $clone = $(node).clone(true, true);
      $clone.removeClass('d-none');
      $clone.css({ display: 'block', visibility: 'visible', position: 'relative' });
      $wrap.append($clone);
    });
    $('body').append($wrap);
    return $wrap;
  }

  function _cleanupPrintWrapper($wrap) {
    if (!$wrap || !$wrap.length) return;
    try { $wrap.remove(); } catch(e) {}
  }

  window.printBookingFormsByIds = function(ids) {
    if (!ids) return;
    ids = Array.isArray(ids) ? ids : [ids];

    var nodes = [];
    ids.forEach(function(id){
      var selector = '.print_area[data-purchase-id="' + id + '"]';
      var el = $(selector)[0];
      if (el) nodes.push(el);
    });

    if (!nodes.length) {
      alert('No booking form found for printing.');
      return;
    }

    var $wrap = _createPrintWrapperForNodes(nodes);

    // Preload background images before printing
    preloadBackgroundImages(nodes, function() {
      var afterPrintHandler = function(){
        try { _cleanupPrintWrapper($wrap); } catch(e) {}
        try { window.removeEventListener('afterprint', afterPrintHandler); } catch(e) {}
      };

      window.addEventListener('afterprint', afterPrintHandler);

      // Additional delay to ensure images are fully rendered
      setTimeout(function(){
        try { window.print(); } catch(e){ console.error('Print error', e); }
        setTimeout(function(){ 
          _cleanupPrintWrapper($wrap); 
          try { window.removeEventListener('afterprint', afterPrintHandler); } catch(e){}
        }, 3000);
      }, 500); // Increased delay for image rendering
    });
  };

  // Wire individual print button(s) -> print only that booking form
  $(document).off('click', '.print-booking-form').on('click', '.print-booking-form', function(e){
    e.preventDefault();
    var id = $(this).data('id');
    if (!id) { alert('Booking id missing'); return; }
    printBookingFormsByIds([id]);
  });

  // Global functions for dropdown actions
  window.generatePurchaseReport = function(purchaseId) {
    // Placeholder for report generation
    alert('Generate Purchase Report functionality for purchase ID: ' + purchaseId);
  };

  window.exportPurchaseData = function(purchaseId) {
    // Placeholder for data export
    alert('Export Purchase Data functionality for purchase ID: ' + purchaseId);
  };

});
</script>

</div>